# 機能要件

## 1. イベント管理

### 1.1 イベント作成 ✅ 実装済み

**概要**: 新しいイベントを作成する

**入力**:
- イベント名（必須、1〜255文字）
- イベント種別（normal: 通常営業 / special: 特別イベント）
- 説明（任意）

**処理**:
1. バリデーション実行
2. イベントIDを生成（ULID）
3. データベースに保存

**出力**:
- 作成されたイベント情報

**API**: `POST /api/v1/events`

### 1.2 イベント一覧取得 ✅ 実装済み

**概要**: 登録されたイベントの一覧を取得する

**入力**:
- is_active（任意、有効なイベントのみ絞り込み）

**処理**:
1. テナント内のイベントを検索
2. 論理削除されていないものを返却

**出力**:
- イベント一覧

**API**: `GET /api/v1/events`

### 1.3 イベント詳細取得 ✅ 実装済み

**概要**: 指定したイベントの詳細情報を取得する

**入力**:
- event_id（必須）

**処理**:
1. 指定されたIDのイベントを取得

**出力**:
- イベント詳細情報

**API**: `GET /api/v1/events/{event_id}`

### 1.4 イベント更新 ❌ 未実装

**概要**: 既存イベントの情報を更新する

**必要な機能**:
- イベント名の変更
- 説明の変更
- 有効/無効の切り替え

---

## 2. 営業日管理

### 2.1 営業日作成 ✅ 実装済み

**概要**: イベントに紐づく営業日を作成する

**入力**:
- event_id（必須）
- target_date（必須、YYYY-MM-DD）
- start_time（必須、HH:MM）
- end_time（必須、HH:MM）
- occurrence_type（recurring: 定期 / special: 特別）

**処理**:
1. バリデーション実行
2. 深夜営業の判定（end_time < start_time の場合）
3. データベースに保存

**出力**:
- 作成された営業日情報

**API**: `POST /api/v1/events/{event_id}/business-days`

### 2.2 営業日一覧取得 ✅ 実装済み

**概要**: イベントに紐づく営業日の一覧を取得する

**入力**:
- event_id（必須）

**処理**:
1. 指定イベントの営業日を検索
2. 日付順にソート

**出力**:
- 営業日一覧

**API**: `GET /api/v1/events/{event_id}/business-days`

### 2.3 営業日詳細取得 ✅ 実装済み

**概要**: 指定した営業日の詳細情報を取得する

**入力**:
- business_day_id（必須）

**処理**:
1. 指定されたIDの営業日を取得

**出力**:
- 営業日詳細情報

**API**: `GET /api/v1/business-days/{business_day_id}`

### 2.4 営業日自動生成 ❌ 未実装

**概要**: 定期パターンから営業日を自動生成する

**必要な機能**:
- RecurringPatternの設定（曜日、時間）
- 指定期間の営業日を一括生成
- 重複チェック

---

## 3. シフト枠管理

### 3.1 シフト枠作成 ✅ 実装済み

**概要**: 営業日に紐づくシフト枠を作成する

**入力**:
- business_day_id（必須）
- position_id（必須）
- slot_name（必須、1〜255文字）
- instance_name（任意、同名枠の識別用）
- start_time（必須、HH:MM）
- end_time（必須、HH:MM）
- required_count（必須、1以上の整数）
- priority（任意、優先度）

**処理**:
1. バリデーション実行
2. 深夜営業の判定
3. データベースに保存

**出力**:
- 作成されたシフト枠情報

**API**: `POST /api/v1/business-days/{business_day_id}/shift-slots`

### 3.2 シフト枠一覧取得 ✅ 実装済み

**概要**: 営業日に紐づくシフト枠の一覧を取得する

**入力**:
- business_day_id（必須）

**処理**:
1. 指定営業日のシフト枠を検索
2. 開始時刻順にソート
3. 各枠の割り当て状況を付与

**出力**:
- シフト枠一覧（割り当て人数付き）

**API**: `GET /api/v1/business-days/{business_day_id}/shift-slots`

### 3.3 シフト枠詳細取得 ✅ 実装済み

**概要**: 指定したシフト枠の詳細情報を取得する

**入力**:
- slot_id（必須）

**処理**:
1. 指定されたIDのシフト枠を取得
2. 割り当て済みメンバー情報を含める

**出力**:
- シフト枠詳細情報

**API**: `GET /api/v1/shift-slots/{slot_id}`

### 3.4 シフト枠テンプレート ❌ 未実装

**概要**: よく使うシフト枠構成をテンプレートとして保存・再利用

**必要な機能**:
- テンプレートの保存
- テンプレートからの一括作成

---

## 4. シフト割り当て

### 4.1 シフト確定（割り当て） ✅ 実装済み

**概要**: メンバーをシフト枠に割り当てる

**入力**:
- slot_id（必須）
- member_id（必須）
- note（任意、備考）

**処理**:
1. 枠の空き状況確認
2. 重複チェック（同一枠に同一メンバーが確定済みでないか）
3. 割り当てを作成

**出力**:
- 作成された割り当て情報

**ビジネスルール**:
- 必要人数を超える割り当ては拒否（409 Conflict）
- 既に確定済みの場合は拒否

**API**: `POST /api/v1/shift-assignments`

### 4.2 割り当て一覧取得 ✅ 実装済み

**概要**: シフト割り当ての一覧を取得する

**入力**:
- member_id（任意、メンバー絞り込み）
- assignment_status（任意、confirmed/cancelled）
- start_date（任意、期間絞り込み）
- end_date（任意、期間絞り込み）

**処理**:
1. 条件に合致する割り当てを検索
2. 関連情報（シフト枠、営業日）を結合

**出力**:
- 割り当て一覧（詳細情報付き）

**API**: `GET /api/v1/shift-assignments`

### 4.3 割り当て詳細取得 ✅ 実装済み

**概要**: 指定した割り当ての詳細情報を取得する

**入力**:
- assignment_id（必須）

**処理**:
1. 指定されたIDの割り当てを取得

**出力**:
- 割り当て詳細情報

**API**: `GET /api/v1/shift-assignments/{assignment_id}`

### 4.4 割り当てキャンセル ❌ 未実装

**概要**: 確定済みの割り当てをキャンセルする

**必要な機能**:
- キャンセル理由の記録
- キャンセル日時の記録
- 監査ログへの記録

### 4.5 自動割り当て ❌ 未実装

**概要**: シフト希望に基づいて自動的に割り当てを行う

**必要な機能**:
- 希望優先度の考慮
- 公平性の考慮
- 必要人数の充足確認

---

## 5. メンバー管理

### 5.1 メンバー登録 ✅ 実装済み

**概要**: 新しいメンバーを登録する

**入力**:
- display_name（必須、1〜255文字）
- discord_user_id（任意）
- email（任意）

**処理**:
1. バリデーション実行
2. 重複チェック（Discord ID、メール）
3. データベースに保存

**出力**:
- 作成されたメンバー情報

**API**: `POST /api/v1/members`

### 5.2 メンバー一覧取得 ✅ 実装済み

**概要**: 登録されたメンバーの一覧を取得する

**入力**:
- is_active（任意、有効なメンバーのみ絞り込み）

**処理**:
1. テナント内のメンバーを検索
2. 論理削除されていないものを返却

**出力**:
- メンバー一覧

**API**: `GET /api/v1/members`

### 5.3 メンバー詳細取得 ✅ 実装済み

**概要**: 指定したメンバーの詳細情報を取得する

**入力**:
- member_id（必須）

**処理**:
1. 指定されたIDのメンバーを取得

**出力**:
- メンバー詳細情報

**API**: `GET /api/v1/members/{member_id}`

### 5.4 メンバーロール管理 ❌ 未実装

**概要**: メンバーにロール（店長、副店長、キャスト、スタッフ）を付与・管理する

**必要な機能**:
- ロールの付与
- ロールの剥奪
- 有効期間の設定
- ロール履歴の管理

---

## 6. シフト希望 ❌ 未実装

### 6.1 希望提出

**概要**: メンバーがシフト希望を提出する

**必要な機能**:
- 営業日に対する参加可否
- 希望時間帯の指定
- 希望ポジションの指定（優先順位付き）
- 希望の強さ・備考

### 6.2 希望一覧取得

**概要**: 営業日に対する希望一覧を取得する

**必要な機能**:
- 営業日ごとの希望集計
- メンバーごとの希望一覧
- 提出状況の確認

### 6.3 希望締切管理

**概要**: 希望提出の締切を管理する

**必要な機能**:
- 締切日時の設定
- 締切後の提出制限
- 締切リマインダー

---

## 7. 通知 ❌ 未実装

### 7.1 シフト募集通知

**概要**: シフト募集開始をメンバーに通知する

**必要な機能**:
- Discord通知
- メール通知
- 対象メンバーの選定

### 7.2 シフト確定通知

**概要**: シフト確定結果をメンバーに通知する

**必要な機能**:
- 割り当て結果の通知
- 不採用の場合の通知

### 7.3 出勤リマインダー

**概要**: 出勤前にリマインドを送信する

**必要な機能**:
- 送信タイミングの設定（例：24時間前、1時間前）
- 送信先の自動選定

### 7.4 緊急ヘルプ要請

**概要**: 欠員発生時に補欠を募集する

**必要な機能**:
- 欠員枠の指定
- 対象メンバーへの通知
- 応募受付

---

## 8. 監査ログ ❌ 未実装

### 8.1 操作履歴記録

**概要**: 重要な操作を監査ログに記録する

**対象操作**:
- シフト割り当ての作成・更新・削除
- イベントの作成・更新・削除
- メンバーの作成・更新・削除
- 設定変更

**記録内容**:
- 操作日時
- 操作者
- 操作種別
- 変更前データ
- 変更後データ

### 8.2 履歴参照

**概要**: 監査ログを参照する

**必要な機能**:
- 期間指定での検索
- エンティティ種別での絞り込み
- 操作者での絞り込み

---

## 9. テナント管理 ❌ 未実装

### 9.1 テナント作成

**概要**: 新しいテナントを作成する

**必要な機能**:
- テナント名の設定
- タイムゾーンの設定
- 初期設定

### 9.2 テナント設定

**概要**: テナントの設定を管理する

**必要な機能**:
- 基本情報の変更
- 通知設定
- 機能の有効/無効

---

## 10. 認証・認可 ⚠️ 一部実装

### 10.1 簡易ログイン ✅ 実装済み

**現在の実装**:
- メンバーIDをlocalStorageに保存する簡易認証
- 認証状態による画面遷移制御

### 10.2 Discord OAuth連携 ❌ 未実装

**必要な機能**:
- Discord OAuthによる認証
- Discord IDとメンバーの紐付け

### 10.3 ロールベースアクセス制御 ❌ 未実装

**必要な機能**:
- ロールに基づく機能制限
- 店長/副店長のみがシフト確定可能
- テナント間のアクセス制御

