# 機能要件

## 1. イベント管理

### 1.1 イベント作成 ✅ 実装済み

**概要**: 新しいイベントを作成する

**入力**:
- イベント名（必須、1〜255文字）
- イベント種別（normal: 通常営業 / special: 特別イベント）
- 説明（任意）

**処理**:
1. バリデーション実行
2. イベントIDを生成（ULID）
3. データベースに保存

**出力**:
- 作成されたイベント情報

**API**: `POST /api/v1/events`

### 1.2 イベント一覧取得 ✅ 実装済み

**概要**: 登録されたイベントの一覧を取得する

**入力**:
- is_active（任意、有効なイベントのみ絞り込み）

**処理**:
1. テナント内のイベントを検索
2. 論理削除されていないものを返却

**出力**:
- イベント一覧

**API**: `GET /api/v1/events`

### 1.3 イベント詳細取得 ✅ 実装済み

**概要**: 指定したイベントの詳細情報を取得する

**入力**:
- event_id（必須）

**処理**:
1. 指定されたIDのイベントを取得

**出力**:
- イベント詳細情報

**API**: `GET /api/v1/events/{event_id}`

### 1.4 イベント更新 ❌ 未実装

**概要**: 既存イベントの情報を更新する

**必要な機能**:
- イベント名の変更
- 説明の変更
- 有効/無効の切り替え

---

## 2. 営業日管理

### 2.1 営業日作成 ✅ 実装済み

**概要**: イベントに紐づく営業日を作成する

**入力**:
- event_id（必須）
- target_date（必須、YYYY-MM-DD）
- start_time（必須、HH:MM）
- end_time（必須、HH:MM）
- occurrence_type（recurring: 定期 / special: 特別）

**処理**:
1. バリデーション実行
2. 深夜営業の判定（end_time < start_time の場合）
3. データベースに保存

**出力**:
- 作成された営業日情報

**API**: `POST /api/v1/events/{event_id}/business-days`

### 2.2 営業日一覧取得 ✅ 実装済み

**概要**: イベントに紐づく営業日の一覧を取得する

**入力**:
- event_id（必須）

**処理**:
1. 指定イベントの営業日を検索
2. 日付順にソート

**出力**:
- 営業日一覧

**API**: `GET /api/v1/events/{event_id}/business-days`

### 2.3 営業日詳細取得 ✅ 実装済み

**概要**: 指定した営業日の詳細情報を取得する

**入力**:
- business_day_id（必須）

**処理**:
1. 指定されたIDの営業日を取得

**出力**:
- 営業日詳細情報

**API**: `GET /api/v1/business-days/{business_day_id}`

### 2.4 営業日自動生成 ❌ 未実装

**概要**: 定期パターンから営業日を自動生成する

**必要な機能**:
- RecurringPatternの設定（曜日、時間）
- 指定期間の営業日を一括生成
- 重複チェック

---

## 3. シフト枠管理

### 3.1 シフト枠作成 ✅ 実装済み

**概要**: 営業日に紐づくシフト枠を作成する

**入力**:
- business_day_id（必須）
- position_id（必須）
- slot_name（必須、1〜255文字）
- instance_name（任意、同名枠の識別用）
- start_time（必須、HH:MM）
- end_time（必須、HH:MM）
- required_count（必須、1以上の整数）
- priority（任意、優先度）

**処理**:
1. バリデーション実行
2. 深夜営業の判定
3. データベースに保存

**出力**:
- 作成されたシフト枠情報

**API**: `POST /api/v1/business-days/{business_day_id}/shift-slots`

### 3.2 シフト枠一覧取得 ✅ 実装済み

**概要**: 営業日に紐づくシフト枠の一覧を取得する

**入力**:
- business_day_id（必須）

**処理**:
1. 指定営業日のシフト枠を検索
2. 開始時刻順にソート
3. 各枠の割り当て状況を付与

**出力**:
- シフト枠一覧（割り当て人数付き）

**API**: `GET /api/v1/business-days/{business_day_id}/shift-slots`

### 3.3 シフト枠詳細取得 ✅ 実装済み

**概要**: 指定したシフト枠の詳細情報を取得する

**入力**:
- slot_id（必須）

**処理**:
1. 指定されたIDのシフト枠を取得
2. 割り当て済みメンバー情報を含める

**出力**:
- シフト枠詳細情報

**API**: `GET /api/v1/shift-slots/{slot_id}`

### 3.4 シフト枠テンプレート ❌ 未実装

**概要**: よく使うシフト枠構成をテンプレートとして保存・再利用

**必要な機能**:
- テンプレートの保存
- テンプレートからの一括作成

---

## 4. シフト割り当て

### 4.1 シフト確定（割り当て） ✅ 実装済み

**概要**: メンバーをシフト枠に割り当てる

**入力**:
- slot_id（必須）
- member_id（必須）
- note（任意、備考）

**処理**:
1. 枠の空き状況確認
2. 重複チェック（同一枠に同一メンバーが確定済みでないか）
3. 割り当てを作成

**出力**:
- 作成された割り当て情報

**ビジネスルール**:
- 必要人数を超える割り当ては拒否（409 Conflict）
- 既に確定済みの場合は拒否

**API**: `POST /api/v1/shift-assignments`

### 4.2 割り当て一覧取得 ✅ 実装済み

**概要**: シフト割り当ての一覧を取得する

**入力**:
- member_id（任意、メンバー絞り込み）
- assignment_status（任意、confirmed/cancelled）
- start_date（任意、期間絞り込み）
- end_date（任意、期間絞り込み）

**処理**:
1. 条件に合致する割り当てを検索
2. 関連情報（シフト枠、営業日）を結合

**出力**:
- 割り当て一覧（詳細情報付き）

**API**: `GET /api/v1/shift-assignments`

### 4.3 割り当て詳細取得 ✅ 実装済み

**概要**: 指定した割り当ての詳細情報を取得する

**入力**:
- assignment_id（必須）

**処理**:
1. 指定されたIDの割り当てを取得

**出力**:
- 割り当て詳細情報

**API**: `GET /api/v1/shift-assignments/{assignment_id}`

### 4.4 割り当てキャンセル ❌ 未実装

**概要**: 確定済みの割り当てをキャンセルする

**必要な機能**:
- キャンセル理由の記録
- キャンセル日時の記録
- 監査ログへの記録

### 4.5 自動割り当て ❌ 未実装

**概要**: シフト希望に基づいて自動的に割り当てを行う

**必要な機能**:
- 希望優先度の考慮
- 公平性の考慮
- 必要人数の充足確認

---

## 5. メンバー管理

### 5.1 メンバー登録 ✅ 実装済み

**概要**: 新しいメンバーを登録する

**入力**:
- display_name（必須、1〜255文字）
- discord_user_id（任意）
- email（任意）

**処理**:
1. バリデーション実行
2. 重複チェック（Discord ID、メール）
3. データベースに保存

**出力**:
- 作成されたメンバー情報

**API**: `POST /api/v1/members`

### 5.2 メンバー一覧取得 ✅ 実装済み

**概要**: 登録されたメンバーの一覧を取得する

**入力**:
- is_active（任意、有効なメンバーのみ絞り込み）

**処理**:
1. テナント内のメンバーを検索
2. 論理削除されていないものを返却

**出力**:
- メンバー一覧

**API**: `GET /api/v1/members`

### 5.3 メンバー詳細取得 ✅ 実装済み

**概要**: 指定したメンバーの詳細情報を取得する

**入力**:
- member_id（必須）

**処理**:
1. 指定されたIDのメンバーを取得

**出力**:
- メンバー詳細情報

**API**: `GET /api/v1/members/{member_id}`

### 5.4 メンバーロール管理 ❌ 未実装

**概要**: メンバーにロール（店長、副店長、キャスト、スタッフ）を付与・管理する

**必要な機能**:
- ロールの付与
- ロールの剥奪
- 有効期間の設定
- ロール履歴の管理

---

## 6. シフト希望 ❌ 未実装

### 6.1 希望提出

**概要**: メンバーがシフト希望を提出する

**必要な機能**:
- 営業日に対する参加可否
- 希望時間帯の指定
- 希望ポジションの指定（優先順位付き）
- 希望の強さ・備考

### 6.2 希望一覧取得

**概要**: 営業日に対する希望一覧を取得する

**必要な機能**:
- 営業日ごとの希望集計
- メンバーごとの希望一覧
- 提出状況の確認

### 6.3 希望締切管理

**概要**: 希望提出の締切を管理する

**必要な機能**:
- 締切日時の設定
- 締切後の提出制限
- 締切リマインダー

---

## 7. 通知 ❌ 未実装

### 7.1 シフト募集通知

**概要**: シフト募集開始をメンバーに通知する

**必要な機能**:
- Discord通知
- メール通知
- 対象メンバーの選定

### 7.2 シフト確定通知

**概要**: シフト確定結果をメンバーに通知する

**必要な機能**:
- 割り当て結果の通知
- 不採用の場合の通知

### 7.3 出勤リマインダー

**概要**: 出勤前にリマインドを送信する

**必要な機能**:
- 送信タイミングの設定（例：24時間前、1時間前）
- 送信先の自動選定

### 7.4 緊急ヘルプ要請

**概要**: 欠員発生時に補欠を募集する

**必要な機能**:
- 欠員枠の指定
- 対象メンバーへの通知
- 応募受付

---

## 8. 監査ログ ❌ 未実装

### 8.1 操作履歴記録

**概要**: 重要な操作を監査ログに記録する

**対象操作**:
- シフト割り当ての作成・更新・削除
- イベントの作成・更新・削除
- メンバーの作成・更新・削除
- 設定変更

**記録内容**:
- 操作日時
- 操作者
- 操作種別
- 変更前データ
- 変更後データ

### 8.2 履歴参照

**概要**: 監査ログを参照する

**必要な機能**:
- 期間指定での検索
- エンティティ種別での絞り込み
- 操作者での絞り込み

---

## 9. テナント管理 ❌ 未実装

### 9.1 テナント作成

**概要**: 新しいテナントを作成する

**必要な機能**:
- テナント名の設定
- タイムゾーンの設定
- 初期設定

### 9.2 テナント設定

**概要**: テナントの設定を管理する

**必要な機能**:
- 基本情報の変更
- 通知設定
- 機能の有効/無効

---

## 10. 認証・認可 ⚠️ 一部実装

### 10.1 簡易ログイン ✅ 実装済み

**現在の実装**:
- メンバーIDをlocalStorageに保存する簡易認証
- 認証状態による画面遷移制御

### 10.2 Discord OAuth連携 ❌ 未実装

**必要な機能**:
- Discord OAuthによる認証
- Discord IDとメンバーの紐付け

### 10.3 ロールベースアクセス制御 ❌ 未実装

**必要な機能**:
- ロールに基づく機能制限
- 店長/副店長のみがシフト確定可能
- テナント間のアクセス制御

---

## 11. 出欠確認（Attendance Collection） ❌ 未実装

「調整さん」のような公開URLを発行し、キャストが認証不要で出欠を回答できる機能。
イベント開催日が確定している場合に使用する。

### 11.1 出欠確認作成

**概要**: イベントまたは営業日に対して出欠確認を作成し、公開URLを発行する

**入力**:
- title（必須、1〜255文字）：出欠確認のタイトル
- description（任意）：説明文
- target_type（必須）：対象種別（event / business_day）
- target_id（必須）：対象イベントIDまたは営業日ID
- deadline（任意）：回答締切日時

**処理**:
1. バリデーション実行
2. 出欠確認ID（ULID）を生成
3. 公開アクセス用トークン（UUID v4形式）を生成
4. データベースに保存

**出力**:
- 作成された出欠確認情報
- 公開回答ページURL

**API**: `POST /api/v1/attendance-collections`

### 11.2 出欠確認一覧取得

**概要**: 登録された出欠確認の一覧を取得する

**入力**:
- event_id（任意、イベント絞り込み）
- status（任意、open / closed）

**処理**:
1. テナント内の出欠確認を検索
2. 作成日時順にソート

**出力**:
- 出欠確認一覧（回答数付き）

**API**: `GET /api/v1/attendance-collections`

### 11.3 出欠確認詳細取得（管理者用）

**概要**: 指定した出欠確認の詳細と集計結果を取得する

**入力**:
- collection_id（必須）

**処理**:
1. 出欠確認情報を取得
2. 回答一覧を集計
3. 出席/欠席/未回答をカウント

**出力**:
- 出欠確認詳細情報
- メンバーごとの回答一覧
- 集計結果（出席数、欠席数、未回答数）

**API**: `GET /api/v1/attendance-collections/{collection_id}`

### 11.4 公開回答ページ取得

**概要**: 公開URLからアクセスされた回答ページのデータを取得する

**入力**:
- token（必須、URLパスパラメータ、UUID v4形式）

**処理**:
1. トークンのUUID形式バリデーション（不正な場合は400 Bad Request）
2. トークンから出欠確認を特定（存在しない場合は404 Not Found）
3. 締切チェック（締切後は回答不可のメッセージを返す）
4. 回答可能なメンバー一覧（キャスト一覧）を取得

**出力**:
- 出欠確認タイトル・説明
- 対象イベント/営業日の情報
- 回答可能メンバー一覧（プルダウン用）
- 締切情報

**API**: `GET /api/v1/public/attendance/{token}`

**認証**: 不要（公開API）

### 11.5 出欠回答登録

**概要**: 公開ページからメンバーが出欠を回答する

**入力**:
- token（必須、URLパスパラメータ、UUID v4形式）
- member_id（必須、メンバーマスタから選択、自由入力不可）
- response（必須、attending / absent）
- note（任意、備考）

**処理**:
1. トークンのUUID形式バリデーション（不正な場合は400 Bad Request）
2. トークンから出欠確認を特定（存在しない場合は404 Not Found）
3. 締切チェック
4. メンバー存在チェック（メンバーマスタに存在するか）
5. 既存回答があれば上書き（同一メンバーは1回答）
6. データベースに保存

**出力**:
- 登録された回答情報

**ビジネスルール**:
- 同一メンバーの重複回答は上書きされる
- 締切後の回答は拒否（403 Forbidden）

**API**: `POST /api/v1/public/attendance/{token}/responses`

**認証**: 不要（公開API）

### 11.6 出欠確認クローズ

**概要**: 出欠確認を手動でクローズし、以降の回答を締め切る

**入力**:
- collection_id（必須）

**処理**:
1. ステータスを closed に変更
2. 以降の回答を受け付けない

**出力**:
- 更新された出欠確認情報

**API**: `PATCH /api/v1/attendance-collections/{collection_id}/close`

---

## 12. 日程調整（Date Scheduling） ❌ 未実装

複数の候補日を提示し、メンバーの参加可否を収集してイベント開催日を決定する機能。
イベント開催日が未定の段階で使用する。

### 12.1 日程調整作成

**概要**: 候補日リストを持つ日程調整を作成し、公開URLを発行する

**入力**:
- title（必須、1〜255文字）：日程調整のタイトル
- description（任意）：説明文
- event_id（任意）：関連イベントID
- candidate_dates（必須、配列）：候補日リスト
  - date（必須、YYYY-MM-DD）
  - start_time（任意、HH:MM）
  - end_time（任意、HH:MM）
  - note（任意）
- deadline（任意）：回答締切日時

**処理**:
1. バリデーション実行（候補日は最低1つ）
2. 日程調整ID（ULID）を生成
3. 公開アクセス用トークン（UUID v4形式）を生成
4. 候補日を保存
5. データベースに保存

**出力**:
- 作成された日程調整情報
- 公開回答ページURL

**API**: `POST /api/v1/date-schedules`

### 12.2 日程調整一覧取得

**概要**: 登録された日程調整の一覧を取得する

**入力**:
- status（任意、open / closed / decided）

**処理**:
1. テナント内の日程調整を検索
2. 作成日時順にソート

**出力**:
- 日程調整一覧（回答数付き）

**API**: `GET /api/v1/date-schedules`

### 12.3 日程調整詳細取得（管理者用）

**概要**: 指定した日程調整の詳細と集計結果を取得する

**入力**:
- schedule_id（必須）

**処理**:
1. 日程調整情報を取得
2. 各候補日への回答を集計
3. 参加可能人数でランキング

**出力**:
- 日程調整詳細情報
- 候補日ごとの回答集計
- メンバーごとの回答マトリクス
- 推奨候補日（参加可能人数が最多の日）

**API**: `GET /api/v1/date-schedules/{schedule_id}`

### 12.4 公開回答ページ取得（日程調整）

**概要**: 公開URLからアクセスされた日程調整回答ページのデータを取得する

**入力**:
- token（必須、URLパスパラメータ、UUID v4形式）

**処理**:
1. トークンのUUID形式バリデーション（不正な場合は400 Bad Request）
2. トークンから日程調整を特定（存在しない場合は404 Not Found）
3. 締切チェック
4. 候補日リストを取得
5. 回答可能なメンバー一覧を取得

**出力**:
- 日程調整タイトル・説明
- 候補日リスト
- 回答可能メンバー一覧（プルダウン用）
- 締切情報

**API**: `GET /api/v1/public/date-schedule/{token}`

**認証**: 不要（公開API）

### 12.5 日程調整回答登録

**概要**: 公開ページからメンバーが各候補日への参加可否を回答する

**入力**:
- token（必須、URLパスパラメータ、UUID v4形式）
- member_id（必須、メンバーマスタから選択、自由入力不可）
- responses（必須、配列）：
  - candidate_date_id（必須）
  - availability（必須、available / unavailable / maybe）
- note（任意、全体備考）

**処理**:
1. トークンのUUID形式バリデーション（不正な場合は400 Bad Request）
2. トークンから日程調整を特定（存在しない場合は404 Not Found）
3. 締切チェック
4. メンバー存在チェック（メンバーマスタに存在するか）
5. 既存回答があれば全て上書き
6. データベースに保存

**出力**:
- 登録された回答情報

**ビジネスルール**:
- 同一メンバーの重複回答は上書きされる
- 締切後の回答は拒否
- 全候補日への回答が必須

**API**: `POST /api/v1/public/date-schedule/{token}/responses`

**認証**: 不要（公開API）

### 12.6 日程調整確定

**概要**: 日程調整の結果から開催日を確定し、必要に応じてイベント営業日を作成する

**入力**:
- schedule_id（必須）
- selected_candidate_id（必須、選択した候補日ID）
- create_business_day（任意、boolean）：営業日を自動作成するか

**処理**:
1. 日程調整ステータスを decided に変更
2. 選択された候補日を記録
3. create_business_day=true の場合、営業日を作成
4. 関連するイベントIDがあれば紐付け

**出力**:
- 更新された日程調整情報
- （作成された場合）営業日情報

**API**: `PATCH /api/v1/date-schedules/{schedule_id}/decide`

### 12.7 日程調整クローズ

**概要**: 日程調整を手動でクローズし、以降の回答を締め切る（確定せずに終了）

**入力**:
- schedule_id（必須）

**処理**:
1. ステータスを closed に変更

**出力**:
- 更新された日程調整情報

**API**: `PATCH /api/v1/date-schedules/{schedule_id}/close`

---

## 13. 公開回答ページ ❌ 未実装

出欠確認・日程調整で共通して使用する公開回答ページの要件。

### 13.1 公開回答ページ共通仕様

**概要**: Discord等で共有される、認証不要の回答ページ

**アクセス方法**:
- 出欠確認: `/p/attendance/{token}`
- 日程調整: `/p/schedule/{token}`

**画面要素**:
1. **タイトル・説明エリア**
   - 出欠確認/日程調整のタイトル
   - 説明文
   - 締切日時（あれば）

2. **回答者選択（メンバーマスタ必須）**
   - プルダウン形式
   - 管理者が登録したメンバー（キャスト）一覧から選択
   - 名前でフィルタ可能
   - **自由入力は不可**（MVPでは禁止）
   - **未選択状態では送信ボタン非活性**
   - 該当メンバーがいない場合は「管理者に追加を依頼してください」と案内

3. **回答入力エリア**
   - 出欠確認: 出席/欠席のラジオボタンまたはトグル
   - 日程調整: 候補日ごとに○/×/△のセレクタ

4. **備考入力**
   - 任意のテキスト入力

5. **送信ボタン**
   - 回答を送信
   - 回答者未選択の場合は非活性

**UX要件**:
- モバイルフレンドリーなレスポンシブデザイン
- 送信完了時のフィードバック表示
- 締切後はメッセージ表示のみ（回答フォーム非表示）
- 既に回答済みの場合、前回の回答を表示
- メンバーが0件の場合は警告メッセージと管理者依頼導線を表示

### 13.2 Discord BOT連携

**概要**: Discord BOTから公開URLを発行・共有する

**コマンド例**:
```
/出欠確認 作成 タイトル:1月7日営業 イベント:シトロン通常営業
/日程調整 作成 タイトル:2月特別イベント候補 候補日:2025-02-08,2025-02-15,2025-02-22
```

**BOTの動作**:
1. コマンド受信
2. バックエンドAPIを呼び出して出欠確認/日程調整を作成
3. 発行された公開URLをDiscordチャンネルに投稿
4. （オプション）回答リマインダーの自動投稿

