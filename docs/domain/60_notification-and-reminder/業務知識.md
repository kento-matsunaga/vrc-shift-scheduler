# 概要

本業務は、シフトに関する情報をメンバーに伝えるための「通知」と「リマインド」のルールを定義する。

通知は、シフト募集・シフト確定・欠員発生時のヘルプ要請など、運営からメンバーへの情報共有を行うための重要な業務である。

# 主要な概念

## 通知（Notification）

シフトに関する出来事をメンバーに伝えるメッセージである。

- シフト募集開始の通知
- シフト提出締切のリマインド
- シフト確定の共有
- 営業日前の出勤リマインド
- 欠員発生時の補欠募集

## 通知対象（NotificationTarget）

通知を受け取る対象のグループである。

- テナント全員
- 特定イベントに所属するキャストのみ
- 確定シフトに入っているメンバーのみ
- 補欠・待機メンバーのみ

## 通知タイミング（NotificationTiming）

通知を送るタイミングのルールである。

- シフト募集開始時
- 締切日の数日前／当日
- 営業日の前日／当日数時間前
- 欠員発生直後

# 制約条件

## 業務制約1：通知の対象範囲

- シフト募集・締切に関する通知は、原則として「応募資格を持つメンバー全員」に送られる。
- 出勤リマインドは、その営業日に確定シフトが入っているメンバーのみに送る。

## 業務制約2：通知頻度

- 同じ内容の通知を過度に送信しないよう、通知頻度に上限を設ける。
  - 例：同じ営業日の同じ内容のリマインドは2回までなど。

## 計算制約

- 通知頻度の上限は「同一営業日 × 同一通知種別」ごとにカウントする。
- 対象メンバーが0人の場合、通知処理自体は実行されるが、実際の送信は行わない。

## 法律制約

- 現時点では特になし。

# BDD例

## 業務ルール1：シフト募集開始時の通知

**シナリオ1: 12月通常営業のシフト募集開始を通知する**

```

Given: 2025-12月通常営業分の希望期間が登録されている
And: 希望期間の対象イベントが「シトロンヴェール」である
And: 応募対象が「シトロンヴェールのキャスト全員」と定義されている
When: 希望期間を「募集開始」状態にする
Then: シトロンヴェールに所属する全キャストに対して
「12月通常営業のシフト募集開始」の通知が送られる

```

## 業務ルール2：営業日前日のリマインド

**シナリオ1: 確定シフトに基づく前日リマインド**

```

Given: 2025-11-13 の営業日に対するシフトが「確定」状態である
And: シフト枠A, B, Cなどに複数のメンバーが配置されている
When: 2025-11-12 の所定時刻になった
Then: 2025-11-13 の営業日に確定シフトが入っているメンバーに対して、
出勤リマインド通知が送られる
And: その営業日にシフトが入っていないメンバーには送られない

```

## 業務ルール3：通知対象が0人の場合（異常系）

**シナリオ1: 対象メンバーがいない場合は通知を送らない**

```

Given: 2025-12月特別営業分の希望期間が登録されている
And: 希望期間の対象イベントが「テストイベント」である
And: テストイベントに所属するキャストが0人である
When: 希望期間を「募集開始」状態にする
Then: 通知対象が存在しないため、実際の通知送信は行われない
And: システムエラーにはならず、正常に処理が完了する

```

## 業務ルール4：通知頻度の上限（境界値）

**シナリオ1: 同一営業日に3回目のリマインドは送信されない**

```

Given: 2025-11-13 の営業日に対して、すでに2回のリマインド通知が送られている
And: 通知頻度の上限は「同一営業日×同一通知種別につき2回」と設定されている
When: 2025-11-13 に対する3回目のリマインド送信がトリガーされる
Then: 頻度上限に達しているため、3回目のリマインドは送信されない
And: 送信スキップの理由がログに記録される

```

# PdM確認事項

## 確認項目1：通知チャネルの優先順位

- 通知をどのチャネルで主に届けるか（コミュニティ用チャットツール内の特定チャンネル、個別メッセージなど）を運営としてどう運用するか確認が必要。
PDM回答：設定画面に欲しいかも。対象チャンネルのAPIとかを入力できる場所を用意するとかで対応できない？個人メッセージよりも対象者に＠でメンションが着くとかの方がいいと思う。