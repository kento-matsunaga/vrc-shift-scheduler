# 概要

本ドメインは、テナントの管理者（Admin）の認証・認可、および管理者の招待機能を定義する。

管理者は店長（owner）と副店長（manager）の2種類のロールを持ち、メールアドレスとパスワードで認証を行う。招待リンクを通じて新しい管理者をテナントに追加できる。

# 主要な概念

## 管理者（Admin）

テナントを管理する権限を持つユーザー。

### 属性

| 属性 | 説明 |
|------|------|
| adminID | ULID形式の一意識別子 |
| tenantID | 所属するテナントのID |
| email | ログイン用メールアドレス（テナント内で一意） |
| passwordHash | bcryptでハッシュ化されたパスワード |
| displayName | 表示名 |
| role | owner または manager |
| isActive | アクティブ状態（falseの場合ログイン不可） |
| createdAt | 作成日時 |
| updatedAt | 更新日時 |
| deletedAt | 削除日時（ソフトデリート） |

### ロール

| ロール | 説明 |
|--------|------|
| owner | 店長。最高権限を持ち、すべての操作が可能 |
| manager | 副店長。店長を補佐し、日常的な運営操作が可能 |

### ログイン条件

管理者がログインできる条件：
- `isActive = true`
- `deletedAt IS NULL`

## 招待（Invitation）

新しい管理者をテナントに追加するための仕組み。

### 属性

| 属性 | 説明 |
|------|------|
| invitationID | ULID形式の一意識別子 |
| tenantID | 招待先テナント（招待者のテナントから自動設定） |
| email | 招待するメールアドレス |
| role | 付与するロール（owner/manager） |
| token | セキュアなランダムトークン（64文字hex） |
| createdByAdminID | 招待を作成した管理者のID |
| expiresAt | 招待の有効期限 |
| acceptedAt | 招待が承諾された日時（null = 未承諾） |
| createdAt | 作成日時 |

### 招待フロー

1. 既存の管理者が新しいメールアドレスに対して招待を作成
2. 招待トークンを含むURLが生成される
3. 招待されたユーザーがURLにアクセスし、パスワードを設定
4. 新しい管理者アカウントが作成される

# 制約条件

## 業務制約1：メールアドレスの一意性

- 同一テナント内でメールアドレスは一意
- 異なるテナントでは同じメールアドレスを使用可能

## 業務制約2：招待の有効期限

- 招待には有効期限が設定される
- 期限切れの招待は承諾できない
- 一度承諾された招待は再利用できない

## 業務制約3：招待者の権限

- 招待を作成できるのはアクティブな管理者のみ
- 削除された管理者は招待を作成できない

## 業務制約4：パスワードのセキュリティ

- パスワードはbcryptでハッシュ化して保存
- 平文パスワードはシステムに保存されない

# ユースケース

## UC1: ログイン

**入力**: メールアドレス、パスワード
**出力**: JWTトークン、管理者情報

**フロー**:
1. メールアドレスで管理者を検索（全テナント横断）
2. アクティブ状態と削除状態を確認
3. パスワードをbcryptで検証
4. JWTトークンを発行（adminID, tenantID, role を含む）

## UC2: 管理者招待

**入力**: 招待先メールアドレス、付与ロール、有効期限
**出力**: 招待情報（トークンを含む）

**フロー**:
1. 招待者が有効な管理者であることを確認
2. セキュアなトークンを生成（crypto/rand使用）
3. 招待レコードを作成

## UC3: 招待承諾

**入力**: 招待トークン、新しいパスワード
**出力**: 新しい管理者アカウント

**フロー**:
1. トークンで招待を検索
2. 有効期限と承諾済みかを確認
3. パスワードをハッシュ化
4. 新しい管理者を作成
5. 招待をacceptedとしてマーク
