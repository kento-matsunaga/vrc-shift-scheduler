# 概要

本業務は、シフト管理における重要な操作（シフト希望の提出・修正、シフト確定の変更、設定の変更など）の履歴を残し、後から経緯を確認できるようにすることを目的とする。

VRChatイベント運営では、欠員・トラブル発生時に「誰がいつ何を操作したか」が追えないと、問題の切り分けや説明が困難になる。本業務では、重要な状態変化を監査ログとして扱う。

# 主要な概念

## 監査イベント（AuditEvent）

シフト管理における重要な操作を表すイベントである。

- 例：
  - メンバーがシフト希望を提出した
  - 運営がシフト案を修正した
  - 店長がシフトを確定状態に変更した
  - 営業枠テンプレートを変更した

## 監査対象（AuditSubject）

監査イベントの対象となる業務オブジェクトである。

- シフト希望
- シフト枠
- シフト案・確定シフト
- 営業枠テンプレート
- イベント設定

# 制約条件

## 業務制約1：重要操作の記録

- シフト希望の新規作成・修正・削除は、監査イベントとして記録する。
- シフト案から確定への状態変更、確定からキャンセルへの変更なども記録する。
- 営業枠テンプレートの変更など、シフトに大きな影響を与える設定変更も記録する。

## 業務制約2：参照範囲

- 監査ログは、テナント単位で参照される。
- 運営ロール（店長・副店長など）のみが詳細な監査情報を参照できる。

## 計算制約

- 保持期間を過ぎた監査イベントは、参照対象から除外される（アーカイブまたは削除対象となる）。
- 保持期間は現時点では1年とする（PdM確認済み）。

## 法律制約

- VRChatイベント運営として法的に記録保持が義務付けられる項目は現時点では特にない。
- 保持期間はテナント運営方針に従う。

# BDD例

## 業務ルール1：シフト確定操作の監査

**シナリオ1: シフトを確定した操作を記録する**

```

Given: 2025-11-13 の営業日に対してシフト案が存在する
And: 店長ロールを持つメンバーTがログインしている
When: メンバーTが2025-11-13のシフトを「確定」状態に変更する
Then: 「2025-11-13 シフト確定」という監査イベントが記録される
And: 監査イベントには「操作日時」「操作ユーザー」「対象営業日」が含まれる

```

## 業務ルール2：監査ログの参照権限（異常系）

**シナリオ1: 一般キャストは詳細な監査ログを参照できない**

```

Given: メンバーCは「キャスト」ロールのみを持つ
And: 2025-11-13 のシフト確定に関する監査イベントが存在する
When: メンバーCが監査ログ一覧画面にアクセスする
Then: 監査ログの詳細情報（操作ユーザー、変更内容の詳細など）は表示されない
And: 「参照権限がありません」または該当機能へのアクセス自体が制限される

```

## 業務ルール3：保持期間を超えた監査ログ（境界値）

**シナリオ1: 保持期間を超えたログは参照対象外となる**

```

Given: 2024-01-15 に記録された監査イベントが存在する
And: 監査ログの保持期間は1年と設定されている
And: 現在日時は 2025-02-01 である
When: 店長ロールのメンバーが監査ログ一覧を参照する
Then: 2024-01-15 の監査イベントは一覧に表示されない
And: 保持期間内（2024-02-01以降）のイベントのみが表示される

```

# PdM確認事項

## 確認項目1：監査ログの保持期間

- 監査ログをどの程度の期間保持するか（例：1年、3年）について、運営としての方針を決める必要がある。
ログは今は１年に使用初期スコープ対応で。