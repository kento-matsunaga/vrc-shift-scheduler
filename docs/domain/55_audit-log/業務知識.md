# 監査ログ 業務知識

## 概要

監査ログは、システム内で発生した重要な操作を記録し、追跡可能にするための仕組みである。
「誰が」「いつ」「何を」「どのように」変更したかを記録することで、問題発生時の調査やセキュリティ監査を可能にする。

## 主要な概念

### 監査ログ（AuditLog）

エンティティに対する変更操作を記録するログエントリ。

- 操作対象（エンティティ種別とID）
- 操作種別（作成/更新/削除）
- 操作者（メンバーID）
- 変更前後のデータ
- 操作日時

## 記録対象のエンティティ

以下のエンティティに対する操作が記録対象となる：

| エンティティ | 説明 |
|--------------|------|
| events | イベント |
| recurring_patterns | 定期パターン |
| event_business_days | 営業日 |
| shift_slots | シフト枠 |
| shift_plans | シフト計画 |
| shift_assignments | シフト割り当て |
| members | メンバー |
| positions | ポジション |
| availabilities | 出勤可否（将来実装） |

## 操作種別

| 操作 | 説明 | before | after |
|------|------|--------|-------|
| CREATE | 新規作成 | NULL | 作成データ |
| UPDATE | 更新 | 変更前データ | 変更後データ |
| DELETE | 削除 | 削除前データ | NULL |

## 制約条件

### 業務制約1：操作者の記録

- すべての監査ログには操作者（actor_id）が必須
- 操作者は有効なメンバーIDでなければならない

### 業務制約2：変更データの記録

- CREATE操作では `changed_data_after` が必須
- DELETE操作では `changed_data_before` が必須
- UPDATE操作では両方が必須

### 業務制約3：追跡可能性

- 監査ログは削除不可（イミュータブル）
- タイムスタンプは自動記録

## MVP実装について

現在はMVP段階のため、重要操作（ShiftAssignment CREATE）のみを記録。
将来のバージョンで対象範囲を拡大予定。

## BDD例

### シナリオ1: シフト割り当て作成時の監査ログ記録

```
Given: 管理者アリスがログイン中
And: シフト枠「カウンターA」が存在する
When: アリスがメンバー「ボブ」をカウンターAに割り当てる
Then: 監査ログが作成される
And: entity_type = 'shift_assignments'
And: action = 'CREATE'
And: actor_id = アリスのメンバーID
And: changed_data_after にボブの割り当て情報が記録される
```

### シナリオ2: シフト割り当てキャンセル時の監査ログ記録

```
Given: ボブがカウンターAに割り当て済み
When: アリスがボブの割り当てをキャンセルする
Then: 監査ログが作成される
And: entity_type = 'shift_assignments'
And: action = 'UPDATE'
And: changed_data_before に変更前の状態が記録される
And: changed_data_after に変更後の状態（cancelled）が記録される
```
