# 概要

本ドメインは、メンバーをシフト枠に配置する「シフト割り当て」の管理を定義する。運営は出欠確認の結果や各メンバーの適性を考慮して、手動でシフト割り当てを行う。

# 主要な概念

## シフト割り当て（ShiftAssignment）

シフト割り当ては、メンバーをシフト枠に配置した結果を表すエンティティである。

### 属性

| 属性 | 説明 |
|------|------|
| assignmentID | ULID形式の一意識別子 |
| tenantID | 所属するテナントのID |
| planID | シフトプランID（オプション、NULL許可） |
| slotID | シフト枠ID |
| memberID | 配置されたメンバーのID |
| assignmentStatus | ステータス（confirmed/cancelled） |
| assignmentMethod | 割り当て方法（auto/manual） |
| isOutsidePreference | 希望外配置フラグ |
| assignedAt | 割り当て日時 |
| cancelledAt | キャンセル日時（cancelledの場合） |
| createdAt | 作成日時 |
| updatedAt | 更新日時 |
| deletedAt | 削除日時（ソフトデリート） |

### 割り当てステータス（AssignmentStatus）

| ステータス | 説明 |
|------------|------|
| confirmed | 確定：有効な割り当て |
| cancelled | キャンセル：メンバーがキャンセルした（履歴として保持） |

### 割り当て方法（AssignmentMethod）

| 方法 | 説明 |
|------|------|
| auto | 自動割り当て（将来実装予定） |
| manual | 手動割り当て（管理者による） |

### 希望外配置フラグ（isOutsidePreference）

- true: メンバーが出席回答していない日への配置
- false: メンバーが出席回答した日への配置

### cancelled と deleted_at の違い

- **cancelled**: メンバーがキャンセルした場合。履歴として残り、UIにも表示可能
- **deleted_at**: 管理者が誤って作成した割り当てを削除した場合。履歴から除外

### ドメインメソッド

- `Cancel()`: 割り当てをキャンセル（cancelledAt を設定）
- `Delete()`: ソフトデリート
- `IsConfirmed()`: 有効な割り当てかを判定
- `IsCancelled()`: キャンセル済みかを判定

## シフトプラン（ShiftPlan）

シフトプランは将来的に複数の割り当てをまとめて管理するための概念である。現在の実装では planID は NULL 許可となっており、個別割り当てのみをサポート。

# 制約条件

## 業務制約1：テナント境界

- シフト割り当ては必ず1つのテナントに属する
- 割り当てには同じテナント内のメンバーのみ指定可能
- 割り当てには同じテナント内のシフト枠のみ指定可能

## 業務制約2：シフト枠との関連

- 割り当ては必ず1つのシフト枠に紐づく
- 同一シフト枠に複数のメンバーを割り当て可能（requiredCount まで）

## 業務制約3：重複割り当て防止

- 同一メンバーを同一シフト枠に重複して割り当てることはできない
- ただし、キャンセル済みの割り当てがある場合は新規割り当て可能

## 業務制約4：キャンセル時の制約

- cancelled ステータスの場合、cancelledAt は必須
- confirmed ステータスの場合、cancelledAt は NULL

## 業務制約5：配置人数の上限

- シフト枠の requiredCount を超える割り当ては警告（エラーではない）
- 運用で配置人数を管理

# 割り当てフロー

1. **シフト枠確認**: 営業日のシフト枠一覧を確認
2. **出欠確認**: 出欠確認の回答を確認（参加可能なメンバーを把握）
3. **メンバー選択**: 配置するメンバーを選択
4. **割り当て作成**: シフト枠にメンバーを割り当て
5. **確認・調整**: 必要に応じて割り当てを調整・キャンセル

# 集約設計

## ShiftAssignment

- ShiftAssignment は独立したエンティティ
- 将来的には ShiftPlan 集約内のエンティティとなる可能性あり

# ユースケース

## UC1: シフト割り当て作成

**入力**: テナントID、シフト枠ID、メンバーID、割り当て方法、希望外フラグ
**出力**: 作成されたシフト割り当て

**検証**:
- シフト枠の存在確認
- メンバーの存在確認
- 重複割り当てチェック

## UC2: シフト割り当て一覧取得（メンバーID指定）

**入力**: メンバーID、フィルター条件（日付範囲、ステータス）
**出力**: シフト割り当てリスト

## UC3: シフト割り当て一覧取得（シフト枠ID指定）

**入力**: シフト枠ID
**出力**: シフト割り当てリスト

## UC4: シフト割り当て詳細取得

**入力**: 割り当てID
**出力**: シフト割り当て

## UC5: シフト割り当てキャンセル

**入力**: 割り当てID
**出力**: 更新されたシフト割り当て

**フロー**:
1. 割り当ての存在確認
2. 既にキャンセル済みでないことを確認
3. Cancel メソッドでステータス変更
4. 結果を返す

## UC6: シフト割り当て削除

**入力**: 割り当てID
**出力**: なし（ソフトデリート）

# 実際の出欠（ActualAttendance）

**注意**: 実際の出欠管理機能は別途 ActualAttendance として実装されているが、本ドキュメントの対象外。シフト割り当ては「予定」であり、実際の出欠は別に記録される。
