# 概要

本業務は、集まったシフト希望と営業枠定義に基づき、運営が各枠に誰を配置するかを決定し、その結果を「シフト確定情報」として扱うルールを定義する。

運営は、単に枠を埋めるだけではなく、
- ポジションごとの適正（ILができるかどうか）
- キャストのバランス（新人とベテランの組み合わせ）
- インスタンス間の人数バランス
などを考慮してシフトを組む。

# 主要な概念

## シフト案（ShiftDraft）

シフト希望と営業枠をもとに作成される暫定的な配置案である。

- 営業日ごとの各シフト枠について「候補メンバー」を割り当てた状態
- 運営が微調整する前段階の「叩き台」

## シフト確定（ShiftPlan）

最終的に運営が承認した配置結果である。

- 各シフト枠に対して「配置メンバー」が確定している状態
- 状態として「草案」「仮確定」「確定」「キャンセル」などのフェーズを持つことがある。

# 制約条件

## 業務制約1：配置と希望の関係

- 原則として、配置はメンバーが出勤可能として申告した営業日の範囲内で行う。
- 希望外の配置を行う場合は、運営とメンバーの合意が必要となる。

## 業務制約2：枠の重複配置禁止

- ひとつのシフト枠には、同時に複数のメンバーを配置しない（枠が1人分である場合）。
- 複数人を前提とする枠を扱う場合は、「枠そのものを人数分に分割」して管理する。

## 計算制約

- シフト枠の充足率は「配置済み枠数 ÷ 必要枠数」で算出される。
- 自動割当は希望を出したメンバーの中から、ポジション適性・希望優先度を考慮して行う（PdM確認済み）。
- 同一メンバーが同一営業日の複数枠に配置されることは許可されるが、同一時間帯の重複配置はできない。

## 法律制約

- 現時点では特になし。

# BDD例

## 業務ルール1：希望を反映したシフト案の作成

**シナリオ1: 出勤可能者で枠を埋める**

```

Given: 2025-11-13 の「シトロン通常営業」に対して、
九龍想定テンプレートをもとに A〜H のシフト枠が二つのインスタンス分存在する
And: 各メンバーが2025-11-13に対するシフト希望を提出済みである
When: 運営がシフト案を作成する
Then: 各シフト枠には、その営業日に出勤可能と申告したメンバーの中から
候補メンバーが割り当てられる
And: 希望を出していないメンバーは候補には含まれない

```

## 業務ルール2：確定シフトの公表

**シナリオ1: シフト案から確定シフトに変更する**

```

Given: 2025-11-13 の営業日に対してシフト案が作成され、
各枠に候補メンバーが仮配置されている
And: 店長ロールを持つメンバーTが存在する
When: メンバーTがシフト案を確認し、
問題がないと判断して「確定」状態に変更する
Then: 2025-11-13 の営業日に対するシフトが「確定」として扱われる
And: 確定シフトはメンバー向けに公開される前提となる

```

## 業務ルール3：希望外配置の警告（異常系）

**シナリオ1: 希望を出していないメンバーを配置しようとすると警告が出る**

```

Given: 2025-11-13 の営業日に対してシフト案が作成されている
And: メンバーXは2025-11-13 に対してシフト希望を出していない
When: 運営がメンバーXをカウンターAの枠に配置しようとする
Then: 「希望外配置」の警告が表示される
And: 運営が確認の上で配置を強行することは可能
And: 配置された場合は「希望外配置」としてマークされる

```

## 業務ルール4：枠の必要人数不足（境界値）

**シナリオ1: 必要人数を下回る枠がある状態で確定しようとする**

```

Given: 2025-11-13 の営業日に対してシフト案が作成されている
And: カウンターAの枠には必要人数2人が設定されている
And: カウンターAには1人しか配置されていない
When: 店長ロールのメンバーTがシフトを「確定」しようとする
Then: 「カウンターA：1/2人（不足）」という警告が表示される
And: 運営が確認の上で確定を強行することは可能
And: 確定された場合は「不足枠あり」として記録される

```

# PdM確認事項

## 確認項目1：自動割当の範囲

- 「ある程度自動で埋めてから調整したい」のか、
  「必ず人間が全て手作業で配置する」のかによって、
  シフト案生成ロジックの詳細レベルが変わる。
  PDM回答：ある程度自動で埋めてから調整したいです。なので、自動で埋めつつ後からフロントで自由にシフトを調整できるようにして下さい。
  なのでその業務知識と画面も必要になってきます。手動調整の