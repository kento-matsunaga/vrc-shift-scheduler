---
description: データモデル設計書作成ガイドライン - VRC Shift Scheduler（VRChatイベント向けシフト調整SaaS）のデータモデルを理解しやすく実装しやすい形で文書化するためのテンプレート
globs: **/*データモデル.md
---
# データモデル設計書作成ガイドライン

## 概要

このガイドラインは、**VRC Shift Scheduler サービス（VRChatイベント向けシフト調整・勤怠管理SaaS）** におけるデータモデル設計書の標準的な構成とフォーマットを定義する。

- 主な対象領域：
  - テナント（店舗・団体）
  - イベント（通常営業／特別営業）
  - 営業日・営業枠（イベント営業枠）
  - メンバー（キャスト・運営）
  - シフト希望・シフト確定
  - 通知・監査ログ
- 目的：
  - 複雑な**シフト調整ロジック**や**イベント営業のルール**を支えるデータモデルを、
    - 読みやすく
    - 実装しやすく
    - DDD/マイクロサービス構成と整合的に  
    文書化することを目的とする。

各テーブルには、役割分類（リソース系/イベント系）に加えて、履歴管理が重要な場合は Temporal 分類も明示する。

---

## 文書構成

### 1. 基本構造

```markdown
# [ドメイン／機能名]データモデル

## 概要
- 機能の目的と背景
- 解決する課題
- 実現する機能の範囲（このデータモデルがカバーする範囲）

## 補足事項
### [業務知識項目]について
- 最小限の業務知識説明（例: イベント営業の種別、シフトの扱いなど）
- 法的・制度的な制約（労働時間・休憩・深夜帯などの制約を抽象的に）
- 判定基準や条件（例: シフト連続時間の上限 など）

## データモデル構成
### [概念]の基本構造
1. **[テーブル名1]** (`physical_table_name_1`) - 役割 (リソース系/イベント系, Temporal分類)
2. **[テーブル名2]** (`physical_table_name_2`) - 役割 (リソース系/イベント系, Temporal分類)
3. **[テーブル名3]** (`physical_table_name_3`) - 役割 (リソース系/イベント系, Temporal分類)

※ Temporal分類: Bi-temporal, Uni-temporal (ValidPeriod/TransactionPeriod), Non-temporal のいずれかを記載（履歴管理が重要な場合のみ）

### [主要な業務フロー]
### [代替的な業務フロー]

## [Mermaid ERダイアグラム]

## データ例とSQL実装例
### ケース1: [基本的な設定パターン]
### ケース2: [応用的な設定パターン]
````

---

### 2. 各セクションの詳細

#### 2.1 概要セクション

* **目的**: 対象ドメイン（例: 「シフト希望とシフト確定」「イベント営業枠設定」など）の全体像を簡潔に説明する。
* **内容**:

  * 機能の目的と背景（3〜5行）

    * 例: 「VRChatイベントのキャストシフトを事前に調整し、当日の人員不足や偏りを防ぐ」など
  * 解決する課題（3〜5行）

    * 例: 「調整さん／スプレッドシート運用の限界」「シフト確定の履歴が追えない」など
  * 対応する業務パターン（箇条書き）

    * 例: 通常営業／特別営業／コラボイベント など

#### 2.2 補足事項セクション

* **目的**: データモデルを理解するために必要な**最小限の業務知識**を提供する。
* **内容**:

  * 法的・制度的な制約（労働時間・休憩・深夜帯などを抽象的に）
  * 判定基準や条件

    * 例: 「1人のメンバーが同一営業日内で担当できる連続枠の上限」など
  * 特殊な業務ルール

    * 例: 「特別営業では通常営業とは別のロール（例: 司会／ゲスト）が発生する」など
* **記載方針**:

  * 開発者がテーブル設計を理解するのに必要な最小限の知識のみ記載する。
  * 詳細な業務知識は、別途「業務知識.md」を参照する。
  * 法的制約や判定基準は必須として明記する（ただし具体的な法律名は書かない）。

#### 2.3 データモデル構成セクション

* **目的**: テーブル構成と関係性を一望できる形で説明する。

* **内容**:

  * 基本構造（テーブル一覧と役割）

    * 例: テナント、イベント営業日、営業枠、メンバー、シフト希望、シフト確定、通知、監査ログ など
  * 各業務パターンでのデータ作成フロー

    * 例: 「イベント作成 → 営業日レコード作成 → 営業枠作成 → シフト希望登録 → シフト確定」など
  * テーブル間の関係性（親子関係／1対多／多対多など）

* **記載方針**:

  * テーブル名は **日本語名＋英語物理名** で記載する。

    * 例: `イベント営業日` (`event_business_days`)
  * 役割は1行で簡潔に記述する。

    * 例: 「イベント営業日単位の営業情報（開店時間・閉店時間・種別など）を保持するリソース系テーブル」
  * 関係性は親子関係を明確に記載する。
  * **テーブル分類**: 各テーブルに (リソース系) または (イベント系) を記載する。

    * **リソース系**:

      * 作成・更新・削除されるもの（ライフサイクルを持つ設定・マスタ・状態）
      * 例: テナント、イベント、メンバー、営業枠、シフト確定など
    * **イベント系**:

      * 一度記録されたら変更されない「事実」を扱うテーブル
      * 例: シフト希望提出イベント、シフト調整履歴、通知送信履歴など
  * **Temporal分類**: 履歴管理が重要な場合、リソース系テーブルに以下を記載する。

    * **Bi-temporal**: 「営業枠の有効期間」と「システム記録時間」の2軸で履歴管理する必要がある場合
    * **Uni-temporal (ValidPeriod)**: 営業日や営業枠の「有効期間」を管理する場合
    * **Uni-temporal (TransactionPeriod)**: 更新履歴をシステム時間で追跡するだけでよい場合
    * **Non-temporal**: 履歴管理を行わないテーブル
    * イベント系テーブルと履歴テーブル（`*_history`）には Temporal分類の記載は不要とする。

#### 2.4 ERダイアグラム

* **ツール**: Mermaid 形式を使用する。
* **含むべき要素**:

  * テーブル名（日本語ラベル）
  * 主要フィールド（id、外部キー、業務キー）
  * リレーション（カーディナリティ）
  * 必要に応じて補足コメント

```mermaid
erDiagram
    テナント["テナント (tenants)"] {
        uuid id "テナントID"
        string name "テナント名"
    }

    イベント["イベント (events)"] {
        uuid id "イベントID"
        uuid tenant_id "テナントID"
        string name "イベント名"
        string event_type "イベント種別(通常/特別など)"
    }

    イベント営業日["イベント営業日 (event_business_days)"] {
        uuid id "イベント営業日ID"
        uuid event_id "イベントID"
        date business_date "営業日"
    }

    営業枠["営業枠 (shift_slots)"] {
        uuid id "営業枠ID"
        uuid business_day_id "イベント営業日ID"
        time start_time "開始時刻"
        time end_time "終了時刻"
        string role "担当ロール(バーテンダー/フロア等)"
    }

    シフト希望["シフト希望 (shift_availabilities)"] {
        uuid id "シフト希望ID"
        uuid slot_id "営業枠ID"
        uuid member_id "メンバーID"
    }

    テナント ||--o{ イベント : "1対多 (テナントごとのイベント)"
    イベント ||--o{ イベント営業日 : "1対多 (イベントごとの営業日)"
    イベント営業日 ||--o{ 営業枠 : "1対多 (営業日ごとの枠)"
    営業枠 ||--o{ シフト希望 : "1対多 (枠ごとの希望)"
```

#### 2.5 データ例とSQL実装例

* **目的**: 具体的な実装イメージを開発者に共有する。
* **内容**:

  * 代表的な業務パターン（2〜3パターン）

    * 例: 「通常営業1日＋2枠＋2名希望」「特別営業でロールが異なるパターン」など
  * 実際の `INSERT` 文による具体例
  * コメント付きで処理順序を明示する
  * 取得系（`SELECT` / `JOIN` / 集計）は記載しない。**永続化・更新・削除**に関する例に限定する。

```sql
-- 1. テナント作成
INSERT INTO tenants (id, name) VALUES
('018f1234-aaaa-bbbb-cccc-000000000001', 'シトロン');

-- 2. イベント作成（通常営業）
INSERT INTO events (id, tenant_id, name, event_type) VALUES
('018f1234-aaaa-bbbb-cccc-000000000010', '018f1234-aaaa-bbbb-cccc-000000000001', 'シトロン通常営業', 'normal');

-- 3. イベント営業日作成
INSERT INTO event_business_days (id, event_id, business_date) VALUES
('018f1234-aaaa-bbbb-cccc-000000000020', '018f1234-aaaa-bbbb-cccc-000000000010', '2025-02-14');

-- 4. 営業枠作成（21:00-23:00 / 23:00-25:00 の2枠）
INSERT INTO shift_slots (id, business_day_id, start_time, end_time, role) VALUES
('018f1234-aaaa-bbbb-cccc-000000000030', '018f1234-aaaa-bbbb-cccc-000000000020', '21:00', '23:00', 'バーテンダー'),
('018f1234-aaaa-bbbb-cccc-000000000031', '018f1234-aaaa-bbbb-cccc-000000000020', '23:00', '25:00', 'バーテンダー');

-- 5. シフト希望登録（メンバーAが1枠目を希望）
INSERT INTO shift_availabilities (id, slot_id, member_id) VALUES
('018f1234-aaaa-bbbb-cccc-000000000040', '018f1234-aaaa-bbbb-cccc-000000000030', '018f1234-aaaa-bbbb-cccc-0000000000A1');
```

---

## 実装フロー

### 1. 事前準備

作業開始前に、ユーザーから以下の資料の提供を受ける。

#### 必須資料

* **業務知識文書**（`*業務知識.md`）

  * 対象ドメイン（例: 「テナントとイベント」「営業枠とシフト」「通知」など）の業務ルールが記載されていること。
* （必要に応じて）既存の ER 図やテーブル定義書がある場合は参考として提供してもらう。

#### 資料提供がない場合の対応

* 業務知識資料の提供がない場合:

  * 業務知識や法的制約に関する資料がないため、適切なデータモデル設計書を作成できない。
  * 対象ドメインの `*業務知識.md` の作成または提供を依頼し、作業を中断する。

### 2. 文書作成手順

#### ステップ1: 概要セクション作成

1. 対象ドメインの目的と背景を3〜5行で記載する。
2. 解決する課題を明確にする。
3. 対応する業務パターンを箇条書きで列挙する。

#### ステップ2: 補足事項セクション作成

1. 開発に必要な最小限の業務知識を抽出する。
2. 労働時間・休憩・深夜帯などの法的制約や判定基準を明記する（法律名は書かない）。
3. 詳細な業務知識は別資料（`*業務知識.md`）を参照する旨を記載する。

#### ステップ3: データモデル構成セクション作成

1. 基本構造（テーブル一覧）を作成する。
2. 各業務パターンでのデータ作成フローを記載する。
3. テーブル間の関係性（親子関係・カーディナリティ）を説明する。
4. 各テーブルに「リソース系／イベント系」と Temporal 分類を付与する。

#### ステップ4: ERダイアグラム作成

1. Mermaid 形式で ER ダイアグラムを作成する。
2. 日本語テーブル名・フィールド名を使用する。
3. 主要なリレーションを明示する。
4. 必要に応じてコメントを追加する。

#### ステップ5: 具体例作成

1. 代表的な業務パターンを 2〜3 パターン選定する。
2. 実際の `INSERT` 文で具体例を作成する。
3. 処理順序をコメントで明示する。
4. UUID は実例形式で統一する。
5. 取得系（`SELECT` / `JOIN` / 集計）は記載せず、永続化／更新／削除に限定する。

---

## 品質チェック

### 3.1 構成チェック

* [ ] 全セクション（概要／補足事項／データモデル構成／ERダイアグラム／データ例）が含まれているか。
* [ ] 各セクションの目的が明確か。
* [ ] 業務知識の詳細が「業務知識.md」と適切に分離されているか。

### 3.2 内容チェック

* [ ] ERダイアグラムが正確か。
* [ ] 具体例の SQL が実行可能か。
* [ ] テーブル名・フィールド名が一貫しているか。
* [ ] 各テーブルに適切な分類（リソース系/イベント系）が記載されているか。
* [ ] Temporal分類が必要なテーブルにのみ適切に記載されているか。

### 3.3 可読性チェック

* [ ] 開発者が理解しやすい構成か。
* [ ] 実装時に参照しやすい形式か。
* [ ] 業務知識が適切に抽象化されているか。

---

## 命名規則

### ファイル名

* `[ドメイン名]データモデル.md`

  * 例: `テナントとイベントデータモデル.md`
  * 例: `シフトと営業枠データモデル.md`

### 保存場所

* `docs/domain/[ドメイン番号]_[ドメイン名]/[ドメイン名]データモデル.md`

  * 例: `docs/domain/10_tenant-and-event/テナントとイベントデータモデル.md`
  * 例: `docs/domain/20_shift-and-slot/シフトと営業枠データモデル.md`

### テーブル名表記

* ERダイアグラム: 日本語名 + 英語テーブル名

  * 例: `イベント営業日["イベント営業日 (event_business_days)"]`

### フィールド名表記

* 日本語コメント付きで記載する。

  * 例: `uuid tenant_id "テナントID"`

---

## 注意事項

### 業務知識の記載範囲

* 開発に必要な最小限の知識のみ記載する。
* 詳細な業務ルールは `*業務知識.md` を参照する。
* 法的制約や判定基準は必須。

### ERダイアグラムの作成

* Mermaid 形式を使用する。
* 日本語テーブル名を優先する。
* 主要なフィールドのみ記載する。
* リレーションのカーディナリティを明示する。

### 具体例の作成

* 実際に実行可能な SQL を記載する。
* UUID は統一形式で記載する。
* コメントで処理順序を明示する。
* 代表的なパターンのみ（多くて 2〜3 パターン）とする。

このガイドラインに従うことで、VRC Shift Scheduler 全体で一貫性があり理解しやすいデータモデル設計書を作成できる。

```
