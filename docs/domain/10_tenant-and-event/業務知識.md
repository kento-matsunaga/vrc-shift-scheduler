# 概要

本ドメインは、VRChatコンカフェ・イベントにおける「テナント（箱）」「イベント」「営業日」の関係を定義し、シフト管理の前提となる営業スケジュールの土台を作ることを目的とする。

# 主要な概念

## テナント（Tenant）

テナントは、VRChat内で活動するひとつの団体・店舗・イベント運営チームを表す単位である。マルチテナント設計により、各テナントのデータは完全に分離される。

### 属性

| 属性 | 説明 |
|------|------|
| tenantID | ULID形式の一意識別子 |
| tenantName | テナント名 |
| timezone | タイムゾーン（デフォルト: Asia/Tokyo） |
| isActive | アクティブ状態 |
| createdAt | 作成日時 |
| updatedAt | 更新日時 |
| deletedAt | 削除日時（ソフトデリート） |

## イベント（Event）

イベントは、テナントが運営する営業ブランド・企画の単位である。同一テナント内で複数のイベントを持つことができる。

### 属性

| 属性 | 説明 |
|------|------|
| eventID | ULID形式の一意識別子 |
| tenantID | 所属するテナントのID |
| eventName | イベント名（必須、255文字以内） |
| eventType | イベント種別（normal/special） |
| description | 説明（オプション） |
| isActive | アクティブ状態 |
| recurrenceType | 繰り返し種別（none/weekly/biweekly） |
| recurrenceStartDate | 繰り返し開始日（DATE） |
| recurrenceDayOfWeek | 繰り返し曜日（0-6: 日曜=0, 土曜=6） |
| defaultStartTime | デフォルト開始時刻（TIME） |
| defaultEndTime | デフォルト終了時刻（TIME） |
| createdAt | 作成日時 |
| updatedAt | 更新日時 |
| deletedAt | 削除日時（ソフトデリート） |

### イベント種別（EventType）

| 種別 | 説明 |
|------|------|
| normal | 通常営業：定期的に繰り返される営業 |
| special | 特別営業：特定日時のみの単発営業 |

### 繰り返し種別（RecurrenceType）

| 種別 | 説明 |
|------|------|
| none | 定期なし（単発） |
| weekly | 毎週 |
| biweekly | 隔週 |

### ドメインメソッド

- `HasRecurrence()`: 定期設定があるかどうかを返す
- `UpdateEventName(name)`: イベント名を更新
- `UpdateDescription(desc)`: 説明を更新
- `Activate()`: イベントを有効化
- `Deactivate()`: イベントを無効化
- `Delete()`: ソフトデリート

## 営業日（EventBusinessDay）

営業日は、実際にシフトを組む対象となる「1回分の営業日」である。イベントの定期パターンから自動生成されるか、手動で作成される。

### 属性

| 属性 | 説明 |
|------|------|
| businessDayID | ULID形式の一意識別子 |
| tenantID | 所属するテナントのID |
| eventID | 関連するイベントのID |
| targetDate | 営業日（DATE） |
| startTime | 開始時刻（TIME） |
| endTime | 終了時刻（TIME） |
| occurrenceType | 発生種別（recurring/special） |
| recurringPatternID | 定期パターンID（recurringの場合） |
| isActive | アクティブ状態 |
| validFrom | 有効期間開始日（オプション） |
| validTo | 有効期間終了日（オプション） |
| createdAt | 作成日時 |
| updatedAt | 更新日時 |
| deletedAt | 削除日時（ソフトデリート） |

### 発生種別（OccurrenceType）

| 種別 | 説明 |
|------|------|
| recurring | 定期パターンから生成された営業日 |
| special | 手動で作成された特別営業日 |

### ドメインメソッド

- `IsValidOn(date)`: 指定日が有効期間内かどうかを判定
- `DayOfWeek()`: 営業日の曜日を返す
- `Activate()`: 営業日を有効化
- `Deactivate()`: 営業日を無効化
- `SetValidPeriod(from, to)`: 有効期間を設定
- `Delete()`: ソフトデリート

## 定期パターン（RecurringPattern）

定期パターンは、イベントの繰り返しルールを詳細に定義するエンティティである。

### 属性

| 属性 | 説明 |
|------|------|
| patternID | ULID形式の一意識別子 |
| tenantID | 所属するテナントのID |
| eventID | 関連するイベントのID |
| patternType | パターン種別（weekly/monthly_date/custom） |
| config | パターン設定（JSON） |
| createdAt | 作成日時 |
| updatedAt | 更新日時 |
| deletedAt | 削除日時（ソフトデリート） |

### パターン種別（PatternType）

| 種別 | 説明 |
|------|------|
| weekly | 曜日指定（複数曜日可） |
| monthly_date | 月内日付指定（例: 毎月15日） |
| custom | カスタムパターン |

### WeeklyPatternConfig

```json
{
  "day_of_weeks": ["SAT", "SUN"],
  "start_time": "20:00",
  "end_time": "22:00"
}
```

### MonthlyDatePatternConfig

```json
{
  "dates": [1, 15],
  "start_time": "20:00",
  "end_time": "22:00"
}
```

# 制約条件

## 業務制約1：イベントとテナントの関係

- イベントは必ず1つのテナントに属する
- 同一テナント内でイベント名は一意である必要はない（同名イベント可）
- テナント間でのデータ参照・変更は不可能

## 業務制約2：営業日の生成

- 定期イベントから営業日を自動生成できる
- 特別営業日は手動で作成される
- 同一日時に複数の営業日を作成可能（異なるイベント）

## 業務制約3：有効期間の整合性

- `validFrom`と`validTo`は両方設定するか、両方null
- `validFrom`は`validTo`より前でなければならない

## 業務制約4：深夜営業対応

- 終了時刻が開始時刻より前の場合、日付をまたぐ営業として扱う
- 例: 21:00〜02:00 は 21:00 開始、翌日 02:00 終了

## 業務制約5：繰り返し設定の整合性

- `recurrenceType`が`none`以外の場合、`recurrenceDayOfWeek`が必須
- `recurrenceDayOfWeek`は0-6の範囲（日曜=0）

# 集約設計

## Event集約

- Event は集約ルート
- RecurringPattern は Event に紐づくが、独立したエンティティとして管理

## EventBusinessDay

- EventBusinessDay は独立したエンティティ
- Event集約には含まれない（Event は「営業の定義」、EventBusinessDay は「生成されたインスタンス」）

# ユースケース

## UC1: イベント作成

**入力**: テナントID、イベント名、イベント種別、繰り返し設定
**出力**: 作成されたイベント

## UC2: 営業日生成

**入力**: イベントID、対象期間
**出力**: 生成された営業日リスト

## UC3: 特別営業日作成

**入力**: イベントID、日付、時間帯
**出力**: 作成された営業日

## UC4: 営業日一覧取得

**入力**: イベントID、年月
**出力**: 営業日リスト（シフト枠の有無を含む）
