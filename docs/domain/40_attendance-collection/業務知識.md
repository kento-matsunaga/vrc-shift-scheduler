# 概要

本ドメインは、メンバーに対して出欠を事前に確認するための機能を定義する。公開リンクを通じて外部からも回答可能であり、「調整さん」のようなサービスの出欠確認部分に相当する。

# 主要な概念

## 出欠確認（AttendanceCollection）

出欠確認は、複数の対象日に対してメンバーの出欠を収集する集約ルートである。

### 属性

| 属性 | 説明 |
|------|------|
| collectionID | ULID形式の一意識別子 |
| tenantID | 所属するテナントのID |
| title | タイトル（必須、255文字以内） |
| description | 説明（オプション） |
| targetType | 対象種別（event/business_day） |
| targetID | イベントIDまたは営業日ID（オプション） |
| publicToken | 公開リンク用トークン（UUID v4） |
| status | ステータス（open/closed） |
| deadline | 回答期限（オプション） |
| createdAt | 作成日時 |
| updatedAt | 更新日時 |
| deletedAt | 削除日時（ソフトデリート） |

### ステータス（Status）

| ステータス | 説明 |
|------------|------|
| open | 回答受付中 |
| closed | 締切 |

### 対象種別（TargetType）

| 種別 | 説明 |
|------|------|
| event | イベント全体を対象 |
| business_day | 特定の営業日を対象 |

### ドメインメソッド

- `CanRespond(now)`: 現在回答可能かを判定（ステータスと期限をチェック）
- `Close(now)`: ステータスを closed に変更

## 対象日（TargetDate）

対象日は、出欠確認の対象となる日付を表すエンティティである。

### 属性

| 属性 | 説明 |
|------|------|
| targetDateID | ULID形式の一意識別子 |
| collectionID | 親の出欠確認ID |
| targetDate | 対象日（DATE） |
| displayOrder | 表示順序 |
| createdAt | 作成日時 |

## 出欠回答（AttendanceResponse）

出欠回答は、メンバーが特定の対象日に対して提出した回答である。

### 属性

| 属性 | 説明 |
|------|------|
| responseID | ULID形式の一意識別子 |
| tenantID | 所属するテナントのID |
| collectionID | 出欠確認ID |
| memberID | 回答したメンバーのID |
| targetDateID | 対象日ID |
| response | 回答（attending/absent） |
| note | 備考（オプション） |
| respondedAt | 回答日時 |
| createdAt | 作成日時 |
| updatedAt | 更新日時 |

### 回答種別（ResponseType）

| 種別 | 説明 |
|------|------|
| attending | 出席（参加可） |
| absent | 欠席（参加不可） |

# 公開リンク機能

- 出欠確認は publicToken を持ち、認証なしで回答ページにアクセス可能
- 公開リンクURL: `/public/attendance/{publicToken}`
- 公開リンクからはメンバー選択と回答のみ可能

# 制約条件

## 業務制約1：テナント境界

- 出欠確認は必ず1つのテナントに属する
- 回答はテナント内のメンバーのみ可能

## 業務制約2：回答可能条件

- ステータスが open の場合のみ回答可能
- deadline が設定されている場合、期限を過ぎると回答不可

## 業務制約3：回答の一意性

- 同一メンバーが同一対象日に対して複数回答した場合、最新の回答で上書き（UPSERT）

## 業務制約4：対象日の管理

- 出欠確認には1つ以上の対象日が必要
- 対象日の追加・削除は出欠確認作成時のみ

# 集約設計

## AttendanceCollection集約

- AttendanceCollection は集約ルート
- TargetDate は別エンティティとして管理（Repository側で取得）
- AttendanceResponse は集約外（Repository側でUPSERT管理）

# ユースケース

## UC1: 出欠確認作成

**入力**: テナントID、タイトル、説明、対象日リスト、回答期限
**出力**: 作成された出欠確認（公開トークンを含む）

## UC2: 出欠確認一覧取得

**入力**: テナントID
**出力**: 出欠確認リスト

## UC3: 出欠確認詳細取得

**入力**: 出欠確認ID または 公開トークン
**出力**: 出欠確認（対象日、回答を含む）

## UC4: 出欠回答提出

**入力**: 出欠確認ID、メンバーID、対象日ごとの回答リスト
**出力**: 登録された回答

**フロー**:
1. 出欠確認の存在確認
2. 回答可能状態のチェック（CanRespond）
3. 各対象日に対する回答をUPSERT
4. 結果を返す

## UC5: 出欠確認締切

**入力**: 出欠確認ID
**出力**: 更新された出欠確認

## UC6: 公開トークンで出欠確認取得

**入力**: 公開トークン
**出力**: 出欠確認（メンバー一覧、対象日、回答を含む）

# エラー

| エラー | 説明 |
|--------|------|
| ErrCollectionClosed | 出欠確認が締め切られている |
| ErrDeadlinePassed | 回答期限が過ぎている |
| ErrAlreadyClosed | 既に締め切られている |
| ErrCollectionNotFound | 出欠確認が見つからない |
