# 概要

本ドメインは、候補日程に対してメンバーの参加可否を収集する機能を定義する。「調整さん」のような日程調整サービスに相当し、複数の候補日から最適な開催日を決定するために使用される。

# 主要な概念

## 日程調整（DateSchedule）

日程調整は、複数の候補日に対してメンバーの参加可否を収集する集約ルートである。

### 属性

| 属性 | 説明 |
|------|------|
| scheduleID | ULID形式の一意識別子 |
| tenantID | 所属するテナントのID |
| title | タイトル（必須、255文字以内） |
| description | 説明（オプション） |
| eventID | 関連するイベントID（オプション） |
| publicToken | 公開リンク用トークン（UUID v4） |
| status | ステータス（open/closed/decided） |
| deadline | 回答期限（オプション） |
| decidedCandidateID | 決定した候補日のID（decidedの場合） |
| candidates | 候補日のリスト |
| createdAt | 作成日時 |
| updatedAt | 更新日時 |
| deletedAt | 削除日時（ソフトデリート） |

### ステータス（Status）

| ステータス | 説明 |
|------------|------|
| open | 回答受付中 |
| closed | 締切（日程未確定） |
| decided | 日程確定済み |

### ドメインメソッド

- `CanRespond(now)`: 現在回答可能かを判定（ステータスと期限をチェック）
- `Decide(candidateID, now)`: 開催日を決定（ステータスを decided に変更）
- `Close(now)`: ステータスを closed に変更

## 候補日（CandidateDate）

候補日は、日程調整の候補となる日時を表すエンティティである。

### 属性

| 属性 | 説明 |
|------|------|
| candidateID | ULID形式の一意識別子 |
| scheduleID | 親の日程調整ID |
| candidateDate | 候補日（DATE） |
| startTime | 開始時刻（TIME、オプション） |
| endTime | 終了時刻（TIME、オプション） |
| displayOrder | 表示順序 |
| createdAt | 作成日時 |

## 日程調整回答（DateScheduleResponse）

日程調整回答は、メンバーが特定の候補日に対して提出した回答である。

### 属性

| 属性 | 説明 |
|------|------|
| responseID | ULID形式の一意識別子 |
| tenantID | 所属するテナントのID |
| scheduleID | 日程調整ID |
| memberID | 回答したメンバーのID |
| candidateID | 候補日ID |
| availability | 参加可否（available/unavailable/maybe） |
| note | 備考（オプション） |
| respondedAt | 回答日時 |
| createdAt | 作成日時 |
| updatedAt | 更新日時 |

### 参加可否（Availability）

| 種別 | 説明 |
|------|------|
| available | 参加可能 |
| unavailable | 参加不可 |
| maybe | 未定・要相談 |

# 公開リンク機能

- 日程調整は publicToken を持ち、認証なしで回答ページにアクセス可能
- 公開リンクURL: `/public/schedule/{publicToken}`
- 公開リンクからはメンバー選択と回答のみ可能

# 日程決定フロー

1. **日程調整作成**: 候補日を含む日程調整を作成
2. **回答収集**: メンバーが公開リンクまたは管理画面から回答
3. **集計確認**: 各候補日の参加可能人数を確認
4. **日程決定**: 最適な候補日を選択して決定
5. **通知（任意）**: 決定した日程をメンバーに通知

# 制約条件

## 業務制約1：テナント境界

- 日程調整は必ず1つのテナントに属する
- 回答はテナント内のメンバーのみ可能

## 業務制約2：回答可能条件

- ステータスが open の場合のみ回答可能
- deadline が設定されている場合、期限を過ぎると回答不可

## 業務制約3：候補日の必須性

- 日程調整には1つ以上の候補日が必要
- 候補日の追加・削除は日程調整作成時のみ

## 業務制約4：日程決定の制約

- 決定できるのは候補日リスト内の候補日のみ
- 一度決定したら再決定不可（ステータス変更のみ）

## 業務制約5：回答の一意性

- 同一メンバーが同一候補日に対して複数回答した場合、最新の回答で上書き（UPSERT）

# 集約設計

## DateSchedule集約

- DateSchedule は集約ルート
- CandidateDate は集約内のエンティティ（作成時に確定）
- DateScheduleResponse は集約外（Repository側でUPSERT管理）

# ユースケース

## UC1: 日程調整作成

**入力**: テナントID、タイトル、説明、候補日リスト、回答期限
**出力**: 作成された日程調整（公開トークンを含む）

## UC2: 日程調整一覧取得

**入力**: テナントID
**出力**: 日程調整リスト

## UC3: 日程調整詳細取得

**入力**: 日程調整ID または 公開トークン
**出力**: 日程調整（候補日、回答を含む）

## UC4: 日程調整回答提出

**入力**: 日程調整ID、メンバーID、候補日ごとの回答リスト
**出力**: 登録された回答

**フロー**:
1. 日程調整の存在確認
2. 回答可能状態のチェック（CanRespond）
3. 各候補日に対する回答をUPSERT
4. 結果を返す

## UC5: 日程決定

**入力**: 日程調整ID、候補日ID
**出力**: 更新された日程調整

**フロー**:
1. 日程調整の存在確認
2. 候補日の存在確認
3. Decide メソッドでステータス変更
4. 結果を返す

## UC6: 公開トークンで日程調整取得

**入力**: 公開トークン
**出力**: 日程調整（メンバー一覧、候補日、回答を含む）

# エラー

| エラー | 説明 |
|--------|------|
| ErrScheduleClosed | 日程調整が締め切られている |
| ErrDeadlinePassed | 回答期限が過ぎている |
| ErrAlreadyClosed | 既に締め切られている |
| ErrAlreadyDecided | 既に日程が決定されている |
| ErrCandidateNotFound | 候補日が見つからない |
| ErrScheduleNotFound | 日程調整が見つからない |
