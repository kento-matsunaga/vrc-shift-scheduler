# 概要

本システムは、VRChat内で運営されるコンカフェ・バー・イベントにおける「シフト調整・シフト確定・出欠確認・日程調整」を一元的に管理するためのマルチテナント型Webアプリケーションである。

## システムの目的

VRChatにおけるイベント運営では、出演キャスト・スタッフの人数が多く、営業日程も通常営業と特別営業が混在するため、外部サービスやスプレッドシートを組み合わせた運用になりやすい。その結果、シフト調整の抜け漏れ、情報の分散、欠員対応の負荷が発生しやすい。

本システムは、これらの問題を解消するために以下の機能を提供する：

1. **テナント管理**: 複数の運営チームを独立して管理
2. **イベント・営業日管理**: 通常営業パターンと特別営業の両方を扱う
3. **メンバー・ロール管理**: スタッフのロール属性と権限管理
4. **シフト枠・テンプレート管理**: 営業日ごとのシフト枠定義とテンプレート化
5. **出欠確認（Attendance）**: メンバーの出欠を事前に収集
6. **日程調整（Schedule）**: 候補日程に対する参加可否を収集
7. **シフト割り当て**: メンバーをシフト枠に配置

# 主要な概念（実装済み）

## テナント（Tenant）

VRChat内で活動するひとつの団体・店舗・イベント運営チームを指す。マルチテナント設計により、各テナントのデータは完全に分離される。

- 属性: テナントID（ULID）、テナント名、タイムゾーン、アクティブ状態
- すべてのデータはテナントに属し、テナント間でのデータ参照・変更はできない

## 管理者（Admin）

テナントを管理する権限を持つユーザー。メールアドレスとパスワードで認証する。

- **owner（店長）**: 最高権限。すべての操作が可能
- **manager（副店長）**: 店長を補佐し、シフト管理などの操作が可能

## イベント（Event）

テナントが運営する営業・イベントの単位。定期開催（週次・隔週）と単発の特別営業の両方をサポート。

- **通常営業（normal）**: 定期的に繰り返される営業
- **特別営業（special）**: 特定日時のみの単発営業

## 営業日（EventBusinessDay）

実際にシフトを組む対象となる1回分の営業日。イベントの定期パターンから自動生成されるか、手動で作成される。

- **recurring**: 定期パターンから生成された営業日
- **special**: 手動で作成された特別営業日

## メンバー（Member）

テナントに所属し、シフトの対象となる人物。VRChatでの表示名やDiscord IDで識別される。

## ロール（Role）

メンバーに付与される属性・役割タグ。カスタム名称と色を持ち、複数のロールを1人のメンバーに割り当て可能。

- 例: 「ベテラン」「新人」「カウンター担当」「IL可能」など
- フィルタリングやシフト割り当ての参考情報として使用

## ポジション（Position）

営業時に必要となる役割の種別。シフト枠を作成する際のテンプレートとなる。

- 例: 「受付」「案内」「配信」「MC」など
- ポジションごとに表示順序を設定可能

## シフト枠（ShiftSlot）

特定の営業日における、時間帯・ポジションを組み合わせた「複数人分の席」。

- 必要人数（requiredCount）: 何人必要か
- 優先度（priority）: 割り当て優先順位
- 深夜営業対応: 日付をまたぐ時間帯もサポート

## シフト枠テンプレート（ShiftSlotTemplate）

よく使うシフト枠の組み合わせをテンプレートとして保存し、営業日に適用できる。

## シフト割り当て（ShiftAssignment）

メンバーをシフト枠に配置した結果。確定・キャンセルの状態を持つ。

- **confirmed**: 確定済み
- **cancelled**: キャンセル済み（履歴として保持）

## 出欠確認（AttendanceCollection）

メンバーに対して出欠を事前に確認するための仕組み。公開リンクで外部からも回答可能。

- 複数の対象日（TargetDate）を含む
- 回答: attending（参加）/ absent（不参加）

## 日程調整（DateSchedule）

候補日程に対してメンバーの参加可否を収集する仕組み。調整さんのような機能。

- 複数の候補日（CandidateDate）を含む
- 回答: available（参加可）/ unavailable（参加不可）/ maybe（未定）

# ID体系

本システムでは、すべてのエンティティに**ULID（Universally Unique Lexicographically Sortable Identifier）**を使用する。

- 形式: 26文字の英数字
- 特徴: 時系列でソート可能、衝突リスクが極めて低い

公開リンク用のトークンには**UUID v4**を使用する。

# 制約条件

## 業務制約1：テナント境界

- すべてのデータは必ずひとつのテナントに属する
- テナント間でのデータ参照・変更は不可能
- 外部キーにはON DELETE CASCADEを設定し、テナント削除時に関連データも削除

## 業務制約2：ソフトデリート

- ほとんどのエンティティは物理削除ではなくソフトデリート（deleted_at列）を使用
- 履歴の追跡と誤操作からの復旧を可能にする

## 業務制約3：認証と権限

- 管理画面へのアクセスにはAdmin認証（JWT）が必要
- owner/managerのロールに応じた権限制御
- 出欠確認・日程調整は公開トークンでの匿名アクセスをサポート

## 業務制約4：時間帯の扱い

- 深夜営業（日付またぎ）をサポート: 終了時刻 < 開始時刻 の場合は翌日扱い
- タイムゾーンはテナント単位で設定（デフォルト: Asia/Tokyo）
