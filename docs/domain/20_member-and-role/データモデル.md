# メンバー・ロール データモデル

## 概要

メンバー・ロールドメインのデータベーススキーマを定義する。
シフト参加者の管理と、属性タグによる分類機能を実現する。

## ER図

```mermaid
erDiagram
    tenants ||--o{ members : "has"
    tenants ||--o{ roles : "has"
    members ||--o{ member_roles : "has"
    roles ||--o{ member_roles : "has"

    members {
        char(26) member_id PK "ULID形式"
        char(26) tenant_id FK "テナントID"
        varchar(255) display_name "表示名"
        varchar(100) discord_user_id "Discord ID"
        varchar(255) email "メールアドレス"
        boolean is_active "有効フラグ"
        timestamptz created_at "作成日時"
        timestamptz updated_at "更新日時"
        timestamptz deleted_at "削除日時"
    }

    roles {
        char(26) role_id PK "ULID形式"
        char(26) tenant_id FK "テナントID"
        varchar(100) name "ロール名"
        varchar(500) description "説明"
        varchar(20) color "色コード"
        integer display_order "表示順序"
        timestamp created_at "作成日時"
        timestamp updated_at "更新日時"
        timestamp deleted_at "削除日時"
    }

    member_roles {
        char(26) member_id PK_FK "メンバーID"
        char(26) role_id PK_FK "ロールID"
        timestamp assigned_at "付与日時"
    }

    tenants {
        char(26) tenant_id PK "ULID形式"
    }
```

## テーブル定義

### members テーブル

シフトに参加するメンバーを管理するテーブル。

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|----------|----------|------|------------|------|
| member_id | CHAR(26) | NO | - | 主キー（ULID形式） |
| tenant_id | CHAR(26) | NO | - | テナントID（FK） |
| display_name | VARCHAR(255) | NO | - | 表示名 |
| discord_user_id | VARCHAR(100) | YES | NULL | Discord ユーザーID |
| email | VARCHAR(255) | YES | NULL | メールアドレス |
| is_active | BOOLEAN | NO | true | 有効フラグ |
| created_at | TIMESTAMPTZ | NO | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMPTZ | NO | CURRENT_TIMESTAMP | 更新日時 |
| deleted_at | TIMESTAMPTZ | YES | NULL | 削除日時（ソフトデリート） |

**外部キー**:
- `fk_members_tenant`: `tenant_id` → `tenants(tenant_id)` ON DELETE CASCADE

**制約**:
- `members_display_name_check`: `LENGTH(display_name) >= 1`

**インデックス**:
- `idx_members_tenant_discord_unique`: `UNIQUE (tenant_id, discord_user_id) WHERE discord_user_id IS NOT NULL AND deleted_at IS NULL`
- `idx_members_tenant_email_unique`: `UNIQUE (tenant_id, email) WHERE email IS NOT NULL AND deleted_at IS NULL`
- `idx_members_tenant_is_active`: `(tenant_id, is_active) WHERE deleted_at IS NULL`

### roles テーブル

メンバーに付与される役割・属性を管理するテーブル。

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|----------|----------|------|------------|------|
| role_id | CHAR(26) | NO | - | 主キー（ULID形式） |
| tenant_id | CHAR(26) | NO | - | テナントID（FK） |
| name | VARCHAR(100) | NO | - | ロール名 |
| description | VARCHAR(500) | YES | NULL | 説明 |
| color | VARCHAR(20) | YES | NULL | UI表示用の色コード |
| display_order | INTEGER | NO | 0 | 表示順序 |
| created_at | TIMESTAMP | NO | NOW() | 作成日時 |
| updated_at | TIMESTAMP | NO | NOW() | 更新日時 |
| deleted_at | TIMESTAMP | YES | NULL | 削除日時（ソフトデリート） |

**外部キー**:
- `fk_roles_tenant`: `tenant_id` → `tenants(tenant_id)` ON DELETE CASCADE

**インデックス**:
- `idx_roles_tenant_id`: `(tenant_id)`
- `idx_roles_display_order`: `(tenant_id, display_order)`
- `idx_roles_deleted_at`: `(deleted_at)`
- `uq_role_name_per_tenant`: `UNIQUE (tenant_id, name) WHERE deleted_at IS NULL`

### member_roles テーブル

メンバーとロールの多対多関連を管理するテーブル。

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|----------|----------|------|------------|------|
| member_id | CHAR(26) | NO | - | メンバーID（PK, FK） |
| role_id | CHAR(26) | NO | - | ロールID（PK, FK） |
| assigned_at | TIMESTAMP | NO | NOW() | 付与日時 |

**主キー**: `(member_id, role_id)`

**外部キー**:
- `fk_member_roles_member`: `member_id` → `members(member_id)` ON DELETE CASCADE
- `fk_member_roles_role`: `role_id` → `roles(role_id)` ON DELETE CASCADE

**インデックス**:
- `idx_member_roles_role_id`: `(role_id)`

## マイグレーションファイル

- `003_create_members_and_shift_slots.up.sql`: members テーブル作成（positions, shift_slots も含む）
- `014_create_roles_and_member_roles.up.sql`: roles, member_roles テーブル作成

## 備考

### Discord ユーザーIDについて

Discord ユーザーIDは Snowflake形式（18-19桁の数字）で、VARCHAR(100) で十分な余裕を持たせている。
将来的にDiscord APIとの連携を想定している。

### ロールの色コードについて

色コードは16進数形式（例: #FF5733）を想定しているが、バリデーションは行わない。
フロントエンドでの表示時に適切にパースする。
