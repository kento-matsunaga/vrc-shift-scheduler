# 出欠確認・日程調整 設計思想

## 1. 概要

本ドキュメントでは、「出欠確認（Attendance Collection）」と「日程調整（Date Schedule）」機能の設計思想をまとめる。

両機能は「調整さん」のような外部サービスに依存せず、システム内で完結する形で実装する。

---

## 2. 設計の背景

### 2.1 現状の課題

VRChatイベント運営では、以下の2つのシナリオがある：

1. **確定日程型**: イベント開催日が決まった後、キャストの出欠を確認したい
2. **候補日選択型**: 候補日を複数提示し、投票結果からイベント開催日を決めたい

これらを外部サービス（調整さん等）で運用すると以下の問題がある：

- データが分散し、シフト管理システムと連携できない
- 回答者と登録メンバーの紐付けが手作業
- 集計結果を転記する手間

### 2.2 解決アプローチ

システム内で出欠確認・日程調整機能を提供し、以下を実現する：

- メンバーマスタとの統合（プルダウンで選択）
- 集計結果のリアルタイム表示
- シフト割り当てへのスムーズな連携

---

## 3. 共通設計：公開回答ページ

### 3.1 設計コンセプト

出欠確認・日程調整は**同一の設計パターン**で実装し、公開回答ページを使い回す。

```
┌─────────────────────────────────────────────────────────┐
│                  公開回答ページ                          │
│           (Public Response Page)                        │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 共通コンポーネント                               │   │
│  │ - タイトル・説明表示                             │   │
│  │ - 締切表示                                       │   │
│  │ - 回答者選択（メンバープルダウン）               │   │
│  │ - 備考入力                                       │   │
│  │ - 送信ボタン                                     │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 回答入力コンポーネント（差し替え可能）           │   │
│  │                                                   │   │
│  │ [出欠確認の場合]     [日程調整の場合]            │   │
│  │  出席/欠席の選択      候補日×回答のマトリクス    │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 3.2 URL設計

公開回答ページはトークンベースのURLでアクセスする。

| 機能 | URL形式 | 例 |
|------|---------|-----|
| 出欠確認 | `/p/attendance/{token}` | `/p/attendance/550e8400-e29b-41d4-a716-446655440000` |
| 日程調整 | `/p/schedule/{token}` | `/p/schedule/6ba7b810-9dad-11d1-80b4-00c04fd430c8` |

### 3.3 トークン設計

```
公開トークン（Public Token）
├─ 形式: UUID v4（RFC 4122準拠）
├─ 長さ: 36文字（ハイフン含む、例: xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx）
├─ 生成: github.com/google/uuid 等のライブラリを使用
├─ 目的: 認証なしでリソースを特定
├─ 有効期限: 出欠確認/日程調整のステータスに依存
└─ DB型: UUID型（PostgreSQL）+ UNIQUE制約
```

**UUID v4 を採用する理由**:
- 十分なエントロピー（122ビットのランダム性）で推測困難
- 標準化された形式でバリデーションが容易
- PostgreSQLのUUID型で効率的に保存・検索可能
- Go標準ライブラリ互換（`github.com/google/uuid`）

**採用しない形式**:
- nanoid: 短いが標準ではなく、バリデーションルールが独自になる
- 独自形式: セキュリティリスクが高い

**セキュリティ考慮**:
- トークンは122ビットのランダム性を持ち、推測困難
- トークンから他の情報を推測できない
- 締切後は回答不可（ただしページは表示可能）
- 不正なUUID形式のトークンは400 Bad Requestを返す

**バリデーション仕様**:
```go
// バックエンドでのトークンバリデーション
func ValidatePublicToken(token string) error {
    _, err := uuid.Parse(token)
    if err != nil {
        return ErrInvalidTokenFormat // 400 Bad Request
    }
    return nil
}
```

### 3.4 認証不要の理由

公開回答ページは**認証なし**でアクセス可能とする。

**理由**:
1. Discordから即座にアクセスできる利便性
2. 全メンバーがシステムアカウントを持つとは限らない
3. 調整さん等の既存運用と同様のUX

**リスク軽減策**:
- **回答者はメンバーマスタから選択（必須）**: プルダウンで登録済みメンバーのみ選択可能
- **公開ページでのメンバー追加は不可**: 該当メンバーがいない場合は「管理者に追加を依頼してください」と案内
- 同一メンバーの重複回答は上書き（いたずら軽減、最新の意思を反映）
- 締切機能による時間制限
- 管理者は回答を確認・修正可能

### 3.5 回答者選択の仕様

**MVPでの制約**:
- 回答者は必ずメンバープルダウンから選択する（自由入力不可）
- プルダウンには管理者が事前登録したメンバー一覧のみ表示
- 未選択状態では送信ボタンを非活性化

**メンバーが0件の場合**:
```
┌─────────────────────────────────────────────────────────┐
│  ⚠️ 回答可能なメンバーが登録されていません              │
│                                                         │
│  管理者にメンバーの追加を依頼してください。             │
│  追加後、このページを再読み込みしてください。           │
└─────────────────────────────────────────────────────────┘
```

**該当メンバーがいない場合の導線**:
- 公開ページ上に「自分がいない場合」リンクを設置
- クリックすると「管理者に連絡してメンバー登録を依頼してください」とメッセージ表示
- 将来的には管理者への通知機能を追加可能

---

## 4. 出欠確認（Attendance Collection）

### 4.1 ユースケース

**対象シナリオ**: イベント開催日が確定している場合

**フロー**:
```
1. 管理者: 出欠確認を作成
      ↓
2. システム: 公開URLを発行
      ↓
3. 管理者: DiscordにURLを共有
      ↓
4. メンバー: 公開ページで出欠を回答
      ↓
5. 管理者: アプリで集計結果を確認
```

### 4.2 ドメインモデル

```
AttendanceCollection（出欠確認）
├─ collectionID: CollectionID
├─ tenantID: TenantID
├─ title: string
├─ description: string
├─ targetType: event | business_day
├─ targetID: string
├─ publicToken: UUID（v4）  ← UUID v4固定
├─ status: open | closed
├─ deadline: DateTime?
└─ responses: AttendanceResponse[]

AttendanceResponse（出欠回答）
├─ responseID: ResponseID
├─ collectionID: CollectionID
├─ memberID: MemberID
├─ response: attending | absent
├─ note: string
└─ respondedAt: DateTime
```

### 4.3 集計画面

管理者向けの集計画面では以下を表示：

| 項目 | 内容 |
|------|------|
| 出席者一覧 | 出席と回答したメンバー名のリスト |
| 欠席者一覧 | 欠席と回答したメンバー名のリスト |
| 未回答者一覧 | まだ回答していないメンバー名のリスト |
| 集計サマリ | 出席: X名 / 欠席: Y名 / 未回答: Z名 |

---

## 5. 日程調整（Date Schedule）

### 5.1 ユースケース

**対象シナリオ**: イベント開催日が未定で、候補日から決めたい場合

**フロー**:
```
1. 管理者: 日程調整を作成（候補日を設定）
      ↓
2. システム: 公開URLを発行
      ↓
3. 管理者: DiscordにURLを共有
      ↓
4. メンバー: 公開ページで各候補日への参加可否を回答
      ↓
5. 管理者: アプリで集計結果を確認
      ↓
6. 管理者: 開催日を決定 → 営業日を作成
```

### 5.2 ドメインモデル

```
DateSchedule（日程調整）
├─ scheduleID: ScheduleID
├─ tenantID: TenantID
├─ title: string
├─ description: string
├─ eventID: EventID?（関連イベント）
├─ publicToken: UUID（v4）  ← UUID v4固定
├─ status: open | closed | decided
├─ deadline: DateTime?
├─ decidedCandidateID: CandidateDateID?
├─ candidateDates: CandidateDate[]
└─ responses: DateScheduleResponse[]

CandidateDate（候補日）
├─ candidateID: CandidateDateID
├─ scheduleID: ScheduleID
├─ date: Date
├─ startTime: Time?
├─ endTime: Time?
├─ note: string
└─ displayOrder: int

DateScheduleResponse（日程調整回答）
├─ dateResponseID: DateResponseID
├─ scheduleID: ScheduleID
├─ memberID: MemberID
├─ candidateID: CandidateDateID
├─ availability: available | unavailable | maybe
└─ respondedAt: DateTime
```

### 5.3 集計画面

管理者向けの集計画面では以下を表示：

**回答マトリクス表示**:
```
          | 2/8(土) | 2/15(土) | 2/22(土) |
----------|---------|----------|----------|
アリス    |   ○    |    ×    |    ○    |
ボブ      |   ○    |    ○    |    △    |
キャロル  |   ×    |    ○    |    ○    |
----------|---------|----------|----------|
参加可能  |   2    |    2    |    2    |
参加不可  |   1    |    1    |    0    |
未定      |   0    |    0    |    1    |
```

**推奨候補日**: 参加可能人数が最多の日を自動でハイライト

---

## 6. データフロー

### 6.1 出欠確認から営業日シフトへの連携

出欠確認の結果は、シフト割り当ての参考情報として活用できる。

```
出欠確認結果
    │
    │  出席と回答したメンバー
    ↓
シフト割り当て候補として表示
    │
    │  管理者が手動で割り当て
    ↓
シフト確定
```

### 6.2 日程調整から営業日作成への連携

日程調整で開催日を決定した際、営業日を自動作成できる。

```
日程調整で開催日を決定
    │
    │  create_business_day=true の場合
    ↓
営業日を自動作成
    │
    │  参加可能と回答したメンバー情報を引き継ぎ
    ↓
シフト枠作成・割り当て作業へ
```

---

## 7. UI/UX設計指針

### 7.1 公開回答ページ

| 要件 | 説明 |
|------|------|
| モバイルファースト | Discordアプリから開くことが多いためスマホ最適化 |
| シンプル | 最小限の入力で完了できる |
| 即時フィードバック | 送信完了を明確に表示 |
| 既回答表示 | 同一メンバーが再訪問時に前回の回答を表示 |

### 7.2 管理画面

| 要件 | 説明 |
|------|------|
| 一覧性 | 回答状況を一目で把握できる |
| アクション導線 | URLコピー、締切変更、クローズが簡単 |
| 通知連携 | リマインダー送信への導線 |

---

## 8. API設計方針

### 8.1 公開API（認証不要）

```
GET  /api/v1/public/attendance/{token}     # 出欠確認ページデータ取得
POST /api/v1/public/attendance/{token}/responses  # 出欠回答登録

GET  /api/v1/public/date-schedule/{token}  # 日程調整ページデータ取得
POST /api/v1/public/date-schedule/{token}/responses  # 日程調整回答登録
```

### 8.2 管理API（認証必要）

```
# 出欠確認
POST   /api/v1/attendance-collections              # 作成
GET    /api/v1/attendance-collections              # 一覧
GET    /api/v1/attendance-collections/{id}         # 詳細（集計含む）
PATCH  /api/v1/attendance-collections/{id}/close   # クローズ

# 日程調整
POST   /api/v1/date-schedules              # 作成
GET    /api/v1/date-schedules              # 一覧
GET    /api/v1/date-schedules/{id}         # 詳細（集計含む）
PATCH  /api/v1/date-schedules/{id}/decide  # 開催日決定
PATCH  /api/v1/date-schedules/{id}/close   # クローズ
```

---

## 9. 拡張可能性

### 9.1 将来的な拡張

| 機能 | 説明 |
|------|------|
| 複数回答 | 同一イベントに対して複数営業日の出欠をまとめて回答 |
| 回答編集 | 管理者による回答の代理入力・修正 |
| 回答履歴 | 回答の変更履歴を保持 |
| 匿名回答 | 特定のケースで匿名回答を許可 |
| 回答リマインダー | 未回答者への自動リマインド |

### 9.2 Discord BOT連携

```
/出欠確認 作成 タイトル:1月7日営業 対象:シトロン通常営業
→ 出欠確認を作成し、公開URLを投稿

/日程調整 作成 タイトル:2月特別イベント 候補日:2025-02-08,2025-02-15
→ 日程調整を作成し、公開URLを投稿

/出欠確認 集計 ID:xxx
→ 現在の集計結果をDiscordに投稿
```

---

## 10. まとめ

| 項目 | 内容 |
|------|------|
| 共通化 | 公開回答ページは出欠確認・日程調整で共通設計 |
| 認証不要 | トークンベースの公開アクセスで利便性を確保 |
| **公開トークン** | **UUID v4 固定**（36文字、PostgreSQL UUID型 + UNIQUE制約） |
| **回答者選択** | **メンバーマスタから選択必須**（自由入力・追加は不可） |
| メンバー連携 | プルダウンから登録済みメンバーを選択 |
| 集計 | 管理画面でリアルタイム集計を表示 |
| データ連携 | 結果をシフト管理へスムーズに連携可能 |

---

## 更新履歴

| 日付 | 更新内容 |
|------|----------|
| 2025-12-14 | 初版作成 |
| 2025-12-14 | 公開トークンをUUID v4に固定（nanoid廃止）、回答者選択をメンバーマスタ必須に明確化、3.5節追加 |

