# テストシナリオ - Public Alpha

VRC Shift Scheduler の機能を網羅的にテストするためのシナリオ集です。

## 📋 テスト目的

- 正常系の動作確認
- 異常系・エッジケースの検証
- マルチテナント境界の確認
- 同時実行時の競合制御の確認

---

## シナリオA: 基本フロー（正常系）

### 目的
アプリケーションの基本的な使い方を確認する。

### 前提条件
- データベースがリセットされている
- ブラウザのローカルストレージがクリアされている

### 手順

1. **ログイン**
   - [ ] 表示名「管理者A」でログイン
   - [ ] イベント一覧画面に遷移することを確認

2. **イベント作成**
   - [ ] 「新しいイベント」ボタンをクリック
   - [ ] イベント名「テストイベント」、説明「Alpha版テスト」を入力
   - [ ] 作成ボタンをクリック
   - [ ] イベント一覧に新しいイベントが表示されることを確認

3. **営業日追加**
   - [ ] 作成したイベントをクリック
   - [ ] 「営業日を追加」ボタンをクリック
   - [ ] 日付「明日」、時刻「21:00-23:30」を入力
   - [ ] 営業日一覧に追加されることを確認

4. **シフト枠作成**
   - [ ] 作成した営業日をクリック
   - [ ] 「シフト枠を追加」ボタンをクリック
   - [ ] 役職「受付」、必要人数「2」を入力
   - [ ] シフト枠一覧に表示されることを確認
   - [ ] 割り当て状況が「0/2」と表示されることを確認

5. **メンバー登録（別ユーザー）**
   - [ ] ブラウザのシークレットモードを開く
   - [ ] 表示名「メンバーB」でログイン
   - [ ] メンバー一覧に登録されることを確認（管理画面から確認）

6. **シフト割り当て**
   - [ ] 管理者Aのブラウザに戻る
   - [ ] シフト枠の「割り当て」ボタンをクリック
   - [ ] メンバープルダウンから「メンバーB」を選択
   - [ ] 確定ボタンをクリック
   - [ ] 割り当て状況が「1/2」に更新されることを確認

7. **マイシフト確認**
   - [ ] メンバーBのブラウザに戻る
   - [ ] 「マイシフト」メニューをクリック
   - [ ] 割り当てられたシフトが表示されることを確認

### 期待結果
- すべての操作がエラーなく完了する
- データが正しく保存・表示される
- 画面遷移がスムーズである

---

## シナリオB: 満員チェック（異常系）

### 目的
シフト枠の必要人数を超える割り当てが防止されることを確認する。

### 前提条件
- シナリオAが完了している
- シフト枠「受付」（必要人数2）に1人割り当て済み

### 手順

1. **2人目を割り当て**
   - [ ] 別のメンバー「メンバーC」を登録
   - [ ] 管理者Aで「受付」枠にメンバーCを割り当て
   - [ ] 割り当て状況が「2/2」になることを確認

2. **3人目を割り当て（エラー）**
   - [ ] 別のメンバー「メンバーD」を登録
   - [ ] 管理者Aで「受付」枠にメンバーDを割り当てようとする
   - [ ] **期待**: エラーメッセージ「このシフト枠は既に満員です」が表示される
   - [ ] **期待**: 割り当てが失敗し、状態が「2/2」のまま

### 期待結果
- 必要人数を超える割り当ては拒否される
- 適切なエラーメッセージが表示される
- 既存の割り当てに影響がない

---

## シナリオC: 同時確定の競合（同時実行）

### 目的
複数人が同じシフト枠に同時に割り当てようとしたときの競合制御を確認する。

### 前提条件
- シフト枠「配信」（必要人数1）が作成されている
- 3人のメンバー（E, F, G）が登録されている

### 手順

1. **3つのブラウザを開く**
   - [ ] ブラウザ1: 管理者A（メンバーEを割り当て準備）
   - [ ] ブラウザ2: 管理者B（メンバーFを割り当て準備）
   - [ ] ブラウザ3: 管理者C（メンバーGを割り当て準備）

2. **同時に確定ボタンをクリック**
   - [ ] 3つのブラウザで「ほぼ同時に」確定ボタンをクリック
   - [ ] **期待**: 1人だけ成功し、2人は「満員です」エラーが出る
   - [ ] **期待**: シフト枠の状態が「1/1」になる

3. **確認**
   - [ ] データベースに1件だけ割り当てが保存されていることを確認
   - [ ] マイシフト画面で確定されたメンバーのみにシフトが表示される

### 期待結果
- データベースの整合性が保たれる
- `SELECT ... FOR UPDATE` による排他制御が機能している
- 競合が適切にハンドリングされる

---

## シナリオD: 深夜営業（日またぎ）

### 目的
深夜帯（日付をまたぐ営業時間）の表示と動作を確認する。

### 前提条件
- イベントが作成されている

### 手順

1. **深夜営業日を作成**
   - [ ] 営業日: 2025-12-10
   - [ ] 開始時刻: 21:00
   - [ ] 終了時刻: 02:00（翌日）
   - [ ] **期待**: 営業日が正しく保存される

2. **深夜シフト枠を作成**
   - [ ] 役職「深夜配信」
   - [ ] 開始時刻: 23:00
   - [ ] 終了時刻: 01:00（翌日）
   - [ ] **期待**: シフト枠が正しく表示される
   - [ ] **期待**: `is_overnight` フラグが `true` になっている

3. **表示確認**
   - [ ] UI で時刻が正しく表示される（例: 23:00-01:00）
   - [ ] マイシフトで日付が正しく表示される

### 期待結果
- 日またぎの時刻が正しく処理される
- UI で混乱なく表示される
- データベースに正しく保存される

---

## シナリオE: マルチテナント境界（セキュリティ）

### 目的
異なるテナントのデータが混ざらないことを確認する。

### 前提条件
- 2つの異なるテナントが存在する（手動で `tenant_id` を変更）

### 手順

1. **テナントAでデータ作成**
   - [ ] テナントA（`TENANT_A_ID`）でログイン
   - [ ] イベント「イベントA」を作成
   - [ ] メンバー「ユーザーA1」を登録

2. **テナントBでデータ作成**
   - [ ] ローカルストレージの `tenant_id` を `TENANT_B_ID` に変更
   - [ ] ページをリロード
   - [ ] イベント「イベントB」を作成
   - [ ] メンバー「ユーザーB1」を登録

3. **境界確認**
   - [ ] テナントAのイベント一覧に「イベントB」が **表示されない** ことを確認
   - [ ] テナントAのメンバー一覧に「ユーザーB1」が **表示されない** ことを確認
   - [ ] 逆も同様に確認

4. **不正アクセス試行（手動APIテスト）**
   - [ ] テナントAでログイン
   - [ ] API（curl等）でテナントBのイベントIDを指定してアクセス
   - [ ] **期待**: `404 Not Found` または `403 Forbidden` が返される

### 期待結果
- 異なるテナントのデータは完全に分離されている
- `X-Tenant-ID` ヘッダーが正しく機能している
- 不正アクセスが防止されている

---

## シナリオF: バリデーションエラー（入力チェック）

### 目的
不正な入力がサーバー側で適切にバリデーションされることを確認する。

### 手順

1. **空文字入力**
   - [ ] イベント名を空白にして作成
   - [ ] **期待**: 「イベント名は必須です」エラー

2. **不正な時刻入力**
   - [ ] 開始時刻「25:00」（存在しない時刻）
   - [ ] **期待**: 「時刻の形式が不正です」エラー

3. **開始時刻 > 終了時刻**
   - [ ] 開始時刻「22:00」、終了時刻「21:00」
   - [ ] **期待**: 「開始時刻は終了時刻より前である必要があります」エラー

4. **必要人数が0以下**
   - [ ] 必要人数「0」または「-1」
   - [ ] **期待**: 「必要人数は1以上である必要があります」エラー

### 期待結果
- フロントエンドとバックエンドの両方でバリデーションが機能している
- 適切なエラーメッセージが表示される
- 不正なデータがデータベースに保存されない

---

## テスト進捗チェックリスト

### 基本機能
- [ ] シナリオA: 基本フロー
- [ ] シナリオB: 満員チェック
- [ ] シナリオF: バリデーションエラー

### 高度な機能
- [ ] シナリオC: 同時確定の競合
- [ ] シナリオD: 深夜営業
- [ ] シナリオE: マルチテナント境界

### その他
- [ ] ブラウザ互換性テスト（Chrome, Firefox, Safari）
- [ ] モバイル表示テスト
- [ ] ネットワーク遅延時の動作確認

---

## バグ報告

テスト中に見つけたバグは、[quickstart.md](./quickstart.md) に記載されている方法で報告してください。

---

**ありがとうございます！徹底的なテストが品質向上につながります 🙏**

