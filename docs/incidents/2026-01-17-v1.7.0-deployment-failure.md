# インシデントレポート: v1.7.0 デプロイ障害

**発生日時**: 2026-01-17 07:31 JST
**解決日時**: 2026-01-17 08:10 JST
**影響時間**: 約40分
**重大度**: High（本番環境でAPIが500エラーを返す）

## 概要

v1.7.0のデプロイ後、シフト枠関連のAPIが500エラーを返すようになり、ユーザーがシフト枠画面にアクセスできなくなった。

## タイムライン

| 時刻 | イベント |
|------|----------|
| 07:22 | v1.7.0デプロイ開始 |
| 07:26 | デプロイ完了、ヘルスチェックOK |
| 07:31 | ユーザーから500エラー報告 |
| 07:35 | 原因特定（DBに`instance_id`カラムが存在しない） |
| 07:42 | v1.6.0へロールバック開始 |
| 07:46 | ロールバック完了（但し別の問題発生） |
| 07:47 | Viteエラー発生（開発用docker-compose使用のため） |
| 07:55 | 本番用docker-compose.prod.ymlで再起動、v1.6.0で復旧 |
| 08:01 | マイグレーション修正作業開始 |
| 08:03 | マイグレーション037-039適用完了 |
| 08:10 | v1.7.0再デプロイ完了、正常稼働確認 |

## 根本原因

### 1. マイグレーション記録の不整合

過去のデプロイで、マイグレーション026-036が実行されたが、`schema_migrations`テーブルに記録されていなかった。

| 状態 | 値 |
|------|-----|
| `schema_migrations`に記録 | version 1-25（25件） |
| 実際にDBに適用済み | version 1-36（36件相当） |
| v1.7.0が必要とする | version 1-39（39件） |

### 2. マイグレーションツールの動作

マイグレーションツールは`schema_migrations`テーブルを参照して未適用のマイグレーションを判断する。

1. v1.7.0デプロイ時、マイグレーションツールは「026が未適用」と判断
2. 026を実行しようとするが、テーブルが既に存在するためエラー
3. マイグレーションが途中で失敗し、037-039は適用されず
4. しかしアプリケーションは起動してしまう
5. v1.7.0のコードは`instance_id`カラムを参照するがDBに存在しない → 500エラー

### 3. ロールバック時の追加ミス

ロールバック時に `docker-compose.yml`（開発用）を使用してしまい、Vite開発サーバーが起動。
本番ドメインからのアクセスがViteのホスト制限に引っかかり、フロントエンドが表示されなくなった。

```
Blocked request. This host ("vrcshift.com") is not allowed.
```

## 影響

- シフト枠一覧画面が表示されない（約40分間）
- その他のAPI機能は正常に動作

## 解決策

### 即時対応

1. **緊急バックアップ取得**
   ```bash
   docker exec vrc-shift-db pg_dump -U vrcshift vrcshift > /opt/backup_emergency.sql
   ```

2. **v1.6.0へロールバック**
   ```bash
   docker-compose -f docker-compose.prod.yml --env-file .env.prod up -d
   ```

3. **マイグレーション記録の修正**
   ```sql
   INSERT INTO schema_migrations (version) VALUES
   (26), (27), (28), (29), (30), (31), (32), (33), (34), (35), (36);
   ```

4. **残りのマイグレーション適用**
   ```bash
   docker exec vrc-shift-backend /app/migrate -action=up
   ```

5. **v1.7.0再デプロイ**

## 再発防止策

### デプロイ前チェックリスト

- [ ] マイグレーションstatusを確認（`/app/migrate -action=status`）
- [ ] `schema_migrations`の件数とマイグレーションファイル数が一致することを確認
- [ ] ステージング環境で事前にマイグレーションをテスト

### デプロイ手順の改善

1. **マイグレーション実行を明示的に行う**
   - アプリケーション起動前にマイグレーションを実行
   - マイグレーションが失敗したらデプロイを中止

2. **docker-compose.prod.ymlの使用を徹底**
   - デプロイスクリプトに本番用composeファイルをハードコード
   - 開発用composeファイルを本番サーバーに配置しない

3. **ヘルスチェックの強化**
   - `/health`だけでなく、主要APIエンドポイントもチェック
   - マイグレーション状態をヘルスチェックに含める

### ドキュメントの整備

1. **LOCAL_DEPLOY_GUIDE.mdに追記**
   - マイグレーションstatusの確認手順
   - マイグレーション不整合が発生した場合の対処法

2. **緊急時対応手順の整備**
   - ロールバック手順
   - バックアップからのリストア手順

## 学んだこと

1. **マイグレーション記録の整合性は定期的に確認すべき**
   - `schema_migrations`のレコード数とマイグレーションファイル数を比較

2. **ロールバックも本番環境設定で行う**
   - 焦っていても`docker-compose.prod.yml`を使用する

3. **バックアップは複数世代・複数場所に保管**
   - `/tmp`は再起動で消えるため、`/opt`など永続的な場所に保管

4. **書き込み停止してからマイグレーション作業を行う**
   - backendを停止してからDB操作を行うことで、データ不整合を防止

## 関連Issue

- #166: 【緊急】v1.7.0デプロイ後の500エラー：マイグレーション不整合の修正が必要

## バックアップファイル

- `/opt/backup_before_migration_20260117_080134.sql` - マイグレーション作業直前
- `/tmp/backup_emergency_20260117_073442.sql` - 緊急バックアップ（要移動）
