# デプロイレポート: v1.9.0 本番デプロイ

**実施日時**: 2026-01-27 18:49 - 19:10 JST
**完了時刻**: 2026-01-27 19:10 JST
**所要時間**: 約21分
**重大度**: Low（障害なし、デプロイ成功）

## 概要

v1.9.0（リリースステータストグル機能、外部連携設定）の本番デプロイを実施。
いくつかの技術的な問題に遭遇したが、全て解決してデプロイ完了。

## タイムライン

| 時刻 | イベント |
|------|----------|
| 18:46 | ローカルビルド完了、tarball作成（66MB） |
| 18:49 | サーバーへのアップロード完了 |
| 18:49 | サーバーで展開、.env.prod保持 |
| 18:51 | Docker再ビルド開始 |
| 18:52 | 全コンテナ起動完了 |
| 18:54 | マイグレーション(040-043)実行完了 |
| 18:54 | .env.prodにResend/Stripe設定追加 |
| 18:56 | バックエンド再起動 → 環境変数反映されず |
| 18:57 | コンテナ再作成 → 環境変数反映成功 |
| 19:05 | Dockerfileにbatch追加、再ビルド |
| 19:06 | Cronジョブ設定完了 |
| 19:07 | タグv1.9.0作成・プッシュ |
| 19:10 | Issue #217クローズ、デプロイ完了 |

## 遭遇した問題と解決策

### 1. SSH/SCPの認証問題

**問題**: `SSH_ASKPASS`を使用したSCPが動作しない

```bash
# 失敗したコマンド
DISPLAY=:0 SSH_ASKPASS=/tmp/askpass.sh SSH_ASKPASS_REQUIRE=force \
  scp /tmp/vrcshift-deploy.tar.gz root@163.44.103.76:/tmp/
# → Permission denied
```

**原因**: `setsid`を使用しないとSSH_ASKPASSが正しく動作しない

**解決策**:
```bash
# 正しいコマンド
DISPLAY=:0 SSH_ASKPASS=/tmp/askpass.sh SSH_ASKPASS_REQUIRE=force \
  setsid scp -o StrictHostKeyChecking=no /tmp/vrcshift-deploy.tar.gz root@163.44.103.76:/tmp/

# SSHコマンドで出力を取得する場合は -w オプションを追加
DISPLAY=:0 SSH_ASKPASS=/tmp/askpass.sh SSH_ASKPASS_REQUIRE=force \
  setsid -w ssh -o StrictHostKeyChecking=no root@163.44.103.76 "command"
```

**教訓**: `setsid`（または`setsid -w`）を必ず使用する

---

### 2. docker-compose コマンドの違い

**問題**: `docker compose`（スペース）が動作しない

```bash
# 失敗
docker compose -f docker-compose.prod.yml down
# → unknown shorthand flag: 'f' in -f
```

**原因**: サーバーには古いバージョンの`docker-compose`（ハイフン付き）がインストールされている

**解決策**:
```bash
# 正しいコマンド
docker-compose -f docker-compose.prod.yml --env-file .env.prod down
```

**教訓**: サーバーでは`docker-compose`（ハイフン付き）を使用する

---

### 3. 環境変数の反映問題

**問題**: `.env.prod`を更新後、`docker-compose restart`しても環境変数が反映されない

```bash
# .env.prodにRESEND_API_KEY等を追加
docker-compose -f docker-compose.prod.yml restart backend
# → ログに「Resend not configured」と表示される（反映されていない）
```

**原因**: `restart`はコンテナを再起動するだけで、環境変数は読み直されない

**解決策**:
```bash
# コンテナを削除して再作成
docker stop vrc-shift-backend
docker rm vrc-shift-backend
docker-compose -f docker-compose.prod.yml --env-file .env.prod up -d backend
```

**教訓**: 環境変数を変更した場合はコンテナを再作成する必要がある

---

### 4. batchバイナリがDockerfileに含まれていない

**問題**: バッチジョブ用の`/app/batch`がコンテナ内に存在しない

```bash
docker exec vrc-shift-backend ls -la /app/
# → server, migrate, seed のみ。batchがない
```

**原因**: Dockerfileに`batch`コマンドのビルド・コピーが含まれていなかった

**解決策**: Dockerfileを修正
```dockerfile
# ビルドステージに追加
RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build \
    -ldflags="-w -s" \
    -o /app/bin/batch \
    ./cmd/batch/main.go

# ランタイムステージに追加
COPY --from=builder /app/bin/batch /app/batch
```

**教訓**: 新しいコマンドを追加したらDockerfileも更新する

---

### 5. Cronジョブ未設定

**問題**: バッチジョブのCronジョブが設定されていなかった

**解決策**: Cronジョブを追加
```bash
crontab -e
# 以下を追加
0 2 * * * docker exec vrc-shift-backend /app/batch -task=grace-expiry >> /var/log/vrcshift/batch.log 2>&1
0 3 * * 0 docker exec vrc-shift-backend /app/batch -task=webhook-cleanup >> /var/log/vrcshift/batch.log 2>&1
30 3 * * * docker exec vrc-shift-backend /app/batch -task=pending-cleanup >> /var/log/vrcshift/batch.log 2>&1
```

**教訓**: デプロイ時にCronジョブの設定状態も確認する

---

## 成果物

### デプロイ内容
- リリースステータストグル機能（#215）
- Resend API設定
- Stripe sandbox設定
- Dockerfileにbatchコマンド追加
- Cronジョブ設定

### 適用マイグレーション
- 040: add_pending_payment_support
- 041: add_cancel_at_period_end
- 042: create_password_reset_tokens
- 043: create_system_settings

### タグ
- v1.9.0

## 残タスク

- [ ] Stripe本番化時: DashboardでWebhookエンドポイント作成 → `STRIPE_WEBHOOK_SECRET`を取得

## 学んだこと

1. **SSH_ASKPASSには`setsid`が必要**
   - 非対話的環境でパスワード認証を行う場合、`setsid`でセッションを分離する

2. **docker-compose vs docker compose**
   - サーバー環境に応じて適切なコマンドを使用する
   - 本番サーバーでは`docker-compose`（ハイフン付き）

3. **環境変数の反映にはコンテナ再作成が必要**
   - `restart`では不十分、`rm`→`up`が必要

4. **Dockerfileの同期**
   - 新しいバイナリ（batch等）を追加したらDockerfileも更新

5. **Cronジョブの確認**
   - デプロイチェックリストにCronジョブ確認を追加すべき

## 関連Issue/PR

- Issue #217: 本番デプロイ計画
- Issue #218: コードレビュー提案
- PR #215: リリースステータストグル機能
- PR #216: develop → main マージ
