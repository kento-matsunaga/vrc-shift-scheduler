# 検証結果サマリー

## 概要

このドキュメントは、VRC Shift Scheduler プロジェクトの「フロント〜バックエンド〜DB」までの整合性チェック結果をまとめたものです。

---

## 1. 今のコードのままでも、ここまでなら確実に動かせる範囲

### 1.1 動作確認済み機能

以下の機能は、現状のコードのままで動作確認が可能です。

1. **ログイン機能**
   - 表示名による簡易認証
   - テナントIDの取得（URLパラメータ or 環境変数）
   - メンバーの自動登録

2. **イベント管理**
   - イベント一覧表示
   - イベント作成（通常/特別）
   - イベント詳細取得（APIは実装済み、フロント画面は未実装）

3. **営業日管理**
   - 営業日一覧表示
   - 営業日作成
   - 営業日詳細取得（APIは実装済み、フロント画面は未実装）

4. **シフト枠管理**
   - シフト枠一覧表示
   - シフト枠作成
   - シフト枠詳細取得

5. **シフト割り当て**
   - シフト割り当て確定（手動）
   - 満員チェック（サーバー側で実装済み）

6. **自分のシフト一覧**
   - シフト一覧表示（基本的な表示は可能）

### 1.2 動作確認の前提条件

- **ポート設定**: バックエンド `:8080`、フロントエンド `:5173`、API接続 `http://localhost:8080`
- **テナントID**: テスト用のテナントIDを事前に用意する必要がある
- **データベース**: マイグレーションが実行済みであること

---

## 2. ここを直さないと、今後のAuth V2やDiscord連携を安全に乗せられない懸念点

### 2.1 重大な問題（修正必須）

#### 問題1: シフト枠の割り当て状況表示が未実装

**詳細**: `assigned_count` が常に `0` を返す

**影響**:
- 満員チェックができない
- シフト枠の充足状況が分からない
- ユーザーが「満員かどうか」を判断できない

**修正箇所**: `backend/internal/interface/rest/shift_slot_handler.go`
- `GetShiftSlots` メソッド（215-231行目）
- `GetShiftSlotDetail` メソッド（280-293行目）

**修正内容**: `shift_assignments` テーブルを JOIN して実際の割り当て数を取得

---

#### 問題2: シフト割り当ての詳細情報が未実装

**詳細**: `member_display_name`、`slot_name`、`target_date`、`start_time`、`end_time` がレスポンスに含まれない

**影響**:
- 「自分のシフト一覧」で詳細情報が表示できない
- ユーザーが「いつ、どのシフトに割り当てられたか」を確認できない

**修正箇所**: `backend/internal/interface/rest/shift_assignment_handler.go`
- `GetAssignments` メソッド（143-226行目）

**修正内容**: `members`、`shift_slots`、`event_business_days` テーブルを JOIN して必要な情報を取得

---

#### 問題3: 日付範囲フィルタが未実装

**詳細**: `start_date`、`end_date` パラメータが未実装

**影響**:
- 「今後のシフト」「過去のシフト」のフィルタリングが正しく動作しない
- ユーザーが日付範囲でシフトを絞り込めない

**修正箇所**: `backend/internal/interface/rest/shift_assignment_handler.go`
- `GetAssignments` メソッド（160行目のTODOコメント）

**修正内容**: `start_date`、`end_date` パラメータを受け取り、`event_business_days` テーブルと JOIN して日付範囲でフィルタリング

---

### 2.2 軽微な問題（修正推奨）

#### 問題4: ポート設定の不整合

**詳細**: `docker-compose.yml` でバックエンドが `8090` ポートにマッピングされているが、フロントエンドは `8080` を参照

**影響**: Docker Compose で起動した場合、フロントエンドからバックエンドに接続できない

**修正箇所**: `docker-compose.yml` 29行目

**修正内容**: ポートマッピングを `8090:8080` から `8080:8080` に変更

---

#### 問題5: BusinessDay の時刻フォーマット不整合

**詳細**: RESTレスポンスが `HH:MM` 形式だが、TypeScript型は `HH:MM:SS` 形式を期待

**影響**: フロントエンドで時刻をパースする際にエラーになる可能性

**修正箇所**: `backend/internal/interface/rest/business_day_handler.go` 265-266行目

**修正内容**: 時刻フォーマットを `15:04` から `15:04:05` に変更

---

#### 問題6: BusinessDay の updated_at がレスポンスに含まれない

**詳細**: TypeScript型に `updated_at` が定義されているが、RESTレスポンスに含まれない

**影響**: フロントエンドで `updated_at` にアクセスすると `undefined` になる

**修正箇所**: `backend/internal/interface/rest/business_day_handler.go` 259-270行目

**修正内容**: RESTレスポンスに `updated_at` を追加

---

#### 問題7: ShiftAssignment のフィールド不整合

**詳細**: `tenant_id`、`is_outside_preference`、`cancelled_at`、`created_at`、`updated_at` がレスポンスに含まれない

**影響**: フロントエンドでこれらのフィールドにアクセスできない、または型エラーが発生

**修正箇所**: `backend/internal/interface/rest/shift_assignment_handler.go` 178-188行目、204-214行目

**修正内容**: RESTレスポンスに不足しているフィールドを追加

---

### 2.3 Auth V2 や Discord連携への影響

#### 認証方式の混在

**現状**: 
- Auth V1（簡易認証）: `X-Tenant-ID`、`X-Member-ID` ヘッダーを使用
- Auth V2（パスワード＋トークン認証）: 未実装

**懸念点**:
- 認証方式が混在していると、セキュリティリスクが高まる
- Discord連携時に、認証トークンの管理が複雑になる

**推奨対応**:
- Auth V2 の実装前に、Auth V1 の動作を完全に検証する
- 認証方式の切り替え戦略を明確にする

---

#### テナント境界の徹底確認

**現状**: 全リポジトリで `tenant_id` チェックが実装されているが、念のため確認が必要

**懸念点**:
- 他テナントのデータが見える可能性がある
- Discord連携時に、テナント間のデータ漏洩リスクがある

**推奨対応**:
- 全クエリで `tenant_id` が確実に含まれているか確認
- 統合テストでテナント境界をテストする

---

#### エラーハンドリングの統一

**現状**: エラーメッセージが技術的すぎる可能性がある

**懸念点**:
- ユーザーがエラーの原因を理解しにくい
- Discord連携時に、エラーメッセージの表示が不統一になる

**推奨対応**:
- エラーメッセージを日本語化し、ユーザーが理解しやすい形式に統一
- エラーハンドリングの統一規約を策定する

---

## 3. 修正優先度

### 高（即座に修正すべき）

1. **シフト枠の割り当て状況表示**（問題1）
2. **シフト割り当ての詳細情報**（問題2）
3. **日付範囲フィルタ**（問題3）

### 中（近日中に修正すべき）

4. **ポート設定の不整合**（問題4）
5. **BusinessDay の時刻フォーマット**（問題5）
6. **BusinessDay の updated_at**（問題6）

### 低（余裕があれば修正）

7. **ShiftAssignment のフィールド不整合**（問題7）

---

## 4. 次のステップ

### 4.1 即座に実施すべきこと

1. **重大な問題の修正**（問題1-3）
   - シフト枠の割り当て状況表示の実装
   - シフト割り当ての詳細情報の実装
   - 日付範囲フィルタの実装

2. **動作確認**
   - 修正後、手動E2Eテストを実行
   - ブラウザの開発者ツールで API リクエスト・レスポンスを確認

### 4.2 今後検討すべきこと

1. **統合テストの実装**
   - REST API 統合テストの実装（`BACKEND_INTEGRATION_TEST_PLAN.md` 参照）
   - CI/CD での自動実行

2. **Auth V2 の実装準備**
   - 認証方式の切り替え戦略の策定
   - 既存の Auth V1 の動作を完全に検証

3. **Discord連携の実装準備**
   - テナント境界の徹底確認
   - エラーハンドリングの統一

---

**作成日**: 2025-01-XX  
**作成者**: 検証専用アシスタント（Auto）



