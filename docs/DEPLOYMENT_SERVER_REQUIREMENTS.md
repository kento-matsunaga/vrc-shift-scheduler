# サーバー選定・デプロイメント要件まとめ

このドキュメントは、VRC Shift Scheduler を本番環境にデプロイする際に必要なサーバー要件と選定に必要な情報をまとめたものです。

## 📋 目次

- [システム構成](#システム構成)
- [技術スタック](#技術スタック)
- [リソース要件](#リソース要件)
- [ネットワーク要件](#ネットワーク要件)
- [データベース要件](#データベース要件)
- [デプロイメント方法](#デプロイメント方法)
- [環境変数](#環境変数)
- [想定負荷](#想定負荷)
- [セキュリティ要件](#セキュリティ要件)
- [バックアップ要件](#バックアップ要件)
- [推奨サーバー構成](#推奨サーバー構成)
- [クラウドサービス比較](#クラウドサービス比較)

---

## システム構成

このシステムは以下のコンポーネントで構成されています：

### 1. バックエンド API サーバー
- **言語**: Go 1.24+
- **フレームワーク**: go-chi/chi v5
- **データベース**: PostgreSQL 16 (pgx v5)
- **ポート**: 8080 (デフォルト)
- **実行形式**: 単一バイナリ（静的リンク）

### 2. フロントエンド Web サーバー
- **言語**: TypeScript
- **フレームワーク**: React 19 + Vite 7
- **スタイリング**: Tailwind CSS 4
- **ビルド成果物**: 静的ファイル（Nginx で配信）
- **ポート**: 80/443 (本番環境)

### 3. データベース
- **種類**: PostgreSQL 16
- **ポート**: 5432
- **接続**: TCP/IP

### 4. Discord Bot（オプション）
- **言語**: TypeScript
- **ランタイム**: Node.js 22+
- **フレームワーク**: discord.js v14
- **実行**: バックエンドAPIと連携

---

## 技術スタック

### バックエンド
| 技術 | バージョン | 用途 |
|------|-----------|------|
| Go | 1.24+ | プログラミング言語 |
| go-chi/chi | v5 | HTTPルーター |
| pgx | v5 | PostgreSQLドライバー |
| PostgreSQL | 16 | データベース |

### フロントエンド
| 技術 | バージョン | 用途 |
|------|-----------|------|
| React | 19 | UIフレームワーク |
| TypeScript | 5.9+ | 型安全な開発 |
| Vite | 7 | ビルドツール |
| Tailwind CSS | 4 | スタイリング |
| React Router | 7 | ルーティング |

### インフラ
| 技術 | 用途 |
|------|------|
| Docker | コンテナ化 |
| Docker Compose | マルチコンテナ管理 |
| Nginx | フロントエンド配信（本番） |

---

## リソース要件

### 最小構成（小規模運用）

#### バックエンド API サーバー
- **CPU**: 1コア以上
- **メモリ**: 512MB以上（推奨: 1GB）
- **ストレージ**: 5GB以上（ログ含む）
- **OS**: Linux (Alpine Linux 推奨)

#### フロントエンド Web サーバー
- **CPU**: 0.5コア以上
- **メモリ**: 256MB以上（推奨: 512MB）
- **ストレージ**: 1GB以上（静的ファイル）
- **OS**: Linux (Alpine Linux 推奨)

#### データベース
- **CPU**: 1コア以上
- **メモリ**: 1GB以上（推奨: 2GB）
- **ストレージ**: 10GB以上（初期）、月次増加想定
- **OS**: Linux

#### 合計（最小構成）
- **CPU**: 2.5コア以上
- **メモリ**: 2GB以上（推奨: 3.5GB）
- **ストレージ**: 20GB以上

### 推奨構成（中規模運用）

#### バックエンド API サーバー
- **CPU**: 2コア
- **メモリ**: 2GB
- **ストレージ**: 20GB

#### フロントエンド Web サーバー
- **CPU**: 1コア
- **メモリ**: 512MB
- **ストレージ**: 5GB

#### データベース
- **CPU**: 2コア
- **メモリ**: 4GB
- **ストレージ**: 50GB（バックアップ含む）

#### 合計（推奨構成）
- **CPU**: 5コア
- **メモリ**: 6.5GB
- **ストレージ**: 75GB

### 高負荷構成（大規模運用）

#### バックエンド API サーバー
- **CPU**: 4コア以上
- **メモリ**: 4GB以上
- **ストレージ**: 50GB

#### フロントエンド Web サーバー
- **CPU**: 2コア
- **メモリ**: 1GB
- **ストレージ**: 10GB

#### データベース
- **CPU**: 4コア以上
- **メモリ**: 8GB以上
- **ストレージ**: 100GB以上（バックアップ含む）

#### 合計（高負荷構成）
- **CPU**: 10コア以上
- **メモリ**: 13GB以上
- **ストレージ**: 160GB以上

---

## ネットワーク要件

### 必要なポート

| サービス | ポート | プロトコル | 用途 | 外部公開 |
|---------|--------|-----------|------|----------|
| フロントエンド | 80 | HTTP | Webアクセス | ✅ 必須 |
| フロントエンド | 443 | HTTPS | Webアクセス（SSL/TLS） | ✅ 必須 |
| バックエンド | 8080 | HTTP | APIアクセス | ⚠️ リバースプロキシ経由推奨 |
| データベース | 5432 | TCP | PostgreSQL接続 | ❌ 内部のみ |

### ドメイン・DNS要件

- **フロントエンド用ドメイン**: 1つ（例: `scheduler.example.com`）
- **バックエンド用ドメイン**: 1つ（例: `api.example.com`）またはサブパス（例: `scheduler.example.com/api`）
- **SSL/TLS証明書**: Let's Encrypt または商用証明書

### 帯域幅

- **想定**: 小〜中規模のイベント運営
- **同時接続**: 50人以上
- **月間転送量**: 10GB〜50GB程度（初期）

---

## データベース要件

### PostgreSQL 16

#### ストレージ要件
- **初期サイズ**: 約100MB（マイグレーション後）
- **想定データ量**:
  - テナントあたりのメンバー数: 〜100人
  - テナントあたりのイベント数: 〜20個
  - 月あたりの営業日数: 〜100日
  - 営業日あたりのシフト枠数: 〜30枠
- **成長率**: 月次で数GB増加の可能性

#### パフォーマンス要件
- **接続プール**: 最大20接続
- **同時クエリ**: 100 req/s 想定
- **レスポンス時間**: 200ms以内（単一取得）、500ms以内（一覧取得）

#### バックアップ要件
- **頻度**: 日次
- **保持期間**: 7日間
- **リストア目標時間**: 4時間以内

---

## デプロイメント方法

### Docker Compose を使用したデプロイメント（推奨）

このシステムは `docker-compose.prod.yml` を使用してデプロイできます。

#### 必要なファイル
- `docker-compose.prod.yml`
- `backend/Dockerfile`
- `web-frontend/Dockerfile`
- `.env.prod` (環境変数ファイル)

#### デプロイメント手順

1. **サーバーにSSH接続**
   ```bash
   ssh user@your-server.com
   ```

2. **Docker と Docker Compose をインストール**
   ```bash
   # Ubuntu/Debian
   sudo apt update
   sudo apt install docker.io docker-compose-plugin
   sudo systemctl enable docker
   sudo systemctl start docker
   ```

3. **プロジェクトをクローン**
   ```bash
   git clone https://github.com/your-org/vrc-shift-scheduler.git
   cd vrc-shift-scheduler
   ```

4. **環境変数を設定**
   ```bash
   cp .env.prod.example .env.prod
   # .env.prod を編集
   ```

5. **コンテナをビルド・起動**
   ```bash
   docker compose -f docker-compose.prod.yml up -d --build
   ```

6. **データベースマイグレーション**
   ```bash
   docker compose -f docker-compose.prod.yml exec backend ./migrate
   ```

7. **Nginx リバースプロキシ設定**（オプション）
   - フロントエンド: `http://localhost:80` → そのまま
   - バックエンド: `https://api.example.com` → `http://localhost:8080`

### 個別デプロイメント

各コンポーネントを個別にデプロイすることも可能です。

#### バックエンド
- Go バイナリを直接実行
- または Docker コンテナとして実行

#### フロントエンド
- ビルド済み静的ファイルを Nginx で配信
- または Docker コンテナ（Nginx 内蔵）として実行

#### データベース
- マネージド PostgreSQL サービス（推奨）
- または自前で PostgreSQL を構築

---

## 環境変数

### バックエンド（必須）

| 変数名 | 説明 | 例 |
|--------|------|-----|
| `DATABASE_URL` | PostgreSQL 接続文字列 | `postgresql://user:pass@host:5432/dbname?sslmode=require` |
| `PORT` | サーバーポート | `8080` |
| `ENVIRONMENT` | 実行環境 | `production` |
| `ALLOWED_ORIGINS` | CORS許可オリジン | `https://scheduler.example.com` |

### バックエンド（オプション）

| 変数名 | 説明 | デフォルト値 |
|--------|------|--------------|
| `HOST` | バインドホスト | `0.0.0.0` |
| `LOG_LEVEL` | ログレベル | `info` |
| `ENABLE_AUDIT_LOG` | 監査ログ | `false` |
| `ENABLE_NOTIFICATION` | 通知機能 | `false` |

### フロントエンド（必須）

| 変数名 | 説明 | 例 |
|--------|------|-----|
| `VITE_API_BASE_URL` | バックエンドAPIのURL | `https://api.example.com` |

### フロントエンド（オプション）

| 変数名 | 説明 | デフォルト値 |
|--------|------|--------------|
| `VITE_TENANT_ID` | 固定テナントID | なし |
| `VITE_ENABLE_DEBUG` | デバッグモード | `false` |

### データベース（Docker Compose使用時）

| 変数名 | 説明 | 例 |
|--------|------|-----|
| `POSTGRES_DB` | データベース名 | `vrc_shift_scheduler` |
| `POSTGRES_USER` | ユーザー名 | `vrc_shift_user` |
| `POSTGRES_PASSWORD` | パスワード | `secure_password_here` |

詳細は [docs/ENVIRONMENT_VARIABLES.md](ENVIRONMENT_VARIABLES.md) を参照してください。

---

## 想定負荷

### 性能要件

| 操作 | 目標値 | 備考 |
|------|--------|------|
| API レスポンス（一覧取得） | 500ms以内 | 100件程度のデータ |
| API レスポンス（単一取得） | 200ms以内 | |
| API レスポンス（作成/更新） | 300ms以内 | |
| ページ初期表示 | 2秒以内 | |

### 同時接続数

| 項目 | 目標値 | 備考 |
|------|--------|------|
| 同時接続ユーザー数 | 50人以上 | 小〜中規模のイベント運営を想定 |
| API 同時リクエスト | 100 req/s | |

### データ量

| 項目 | 想定値 | 備考 |
|------|--------|------|
| テナントあたりのメンバー数 | 〜100人 | |
| テナントあたりのイベント数 | 〜20個 | |
| 月あたりの営業日数 | 〜100日 | 複数イベント合計 |
| 営業日あたりのシフト枠数 | 〜30枠 | |

---

## セキュリティ要件

### 必須要件

1. **HTTPS/TLS**
   - フロントエンドとバックエンドは HTTPS で通信
   - SSL/TLS 証明書は Let's Encrypt または商用証明書

2. **データベース接続**
   - 本番環境では `sslmode=require` を推奨
   - データベースは外部から直接アクセス不可

3. **環境変数管理**
   - 機密情報（パスワード、トークン）は環境変数で管理
   - `.env` ファイルは Git にコミットしない

4. **CORS設定**
   - `ALLOWED_ORIGINS` に許可するオリジンのみを設定

### 推奨要件

1. **ファイアウォール**
   - 必要なポートのみ開放（80, 443）
   - データベースポート（5432）は内部のみ

2. **ログ監視**
   - アクセスログとエラーログを監視
   - 異常なアクセスパターンを検知

3. **定期的な更新**
   - OS、Docker、アプリケーションのセキュリティパッチを適用

---

## バックアップ要件

### データベースバックアップ

| 項目 | 方針 |
|------|------|
| バックアップ頻度 | 日次 |
| バックアップ保持期間 | 7日間 |
| リストア目標時間 | 4時間以内 |

### バックアップ方法

1. **PostgreSQL ダンプ**
   ```bash
   docker compose -f docker-compose.prod.yml exec postgres pg_dump -U vrc_shift_user vrc_shift_scheduler > backup_$(date +%Y%m%d).sql
   ```

2. **ボリュームバックアップ**（Docker Compose使用時）
   ```bash
   docker compose -f docker-compose.prod.yml exec postgres pg_dumpall -U vrc_shift_user > backup_$(date +%Y%m%d).sql
   ```

3. **自動バックアップスクリプト**
   - cron で日次実行
   - 外部ストレージ（S3、Google Cloud Storage等）にアップロード

---

## 推奨サーバー構成

### オプション1: 単一サーバー構成（小規模）

**用途**: 小規模な運用、初期段階

- **サーバー**: 1台
- **構成**: バックエンド + フロントエンド + データベース（同一サーバー）
- **リソース**: CPU 2コア、メモリ 4GB、ストレージ 50GB
- **コスト**: 月額 $10〜$20

**メリット**:
- シンプルな構成
- 低コスト
- 管理が容易

**デメリット**:
- 単一障害点
- スケーラビリティに限界

### オプション2: 分離構成（中規模）

**用途**: 中規模な運用、本番環境

- **サーバー**: 2台
  - **Webサーバー**: バックエンド + フロントエンド
  - **データベースサーバー**: PostgreSQL
- **リソース**:
  - Webサーバー: CPU 2コア、メモリ 4GB、ストレージ 20GB
  - DBサーバー: CPU 2コア、メモリ 4GB、ストレージ 50GB
- **コスト**: 月額 $30〜$50

**メリット**:
- データベースとアプリケーションの分離
- パフォーマンスの最適化
- バックアップの容易さ

**デメリット**:
- コストが増加
- ネットワーク設定が必要

### オプション3: マネージドサービス構成（推奨）

**用途**: 本番環境、運用負荷を減らしたい場合

- **バックエンド**: PaaS（Render、Fly.io、Railway等）
- **フロントエンド**: 静的ホスティング（Vercel、Netlify、Cloudflare Pages等）
- **データベース**: マネージド PostgreSQL（AWS RDS、Google Cloud SQL、Render PostgreSQL等）

**メリット**:
- 運用負荷が低い
- 自動スケーリング
- バックアップの自動化
- 高可用性

**デメリット**:
- コストが高め
- ベンダーロックインの可能性

---

## クラウドサービス比較

### 日本国内のクラウドサービス

#### 1. さくらのクラウド
- **特徴**: 日本国内、低価格、柔軟な構成
- **推奨プラン**: スタンダードプラン（2コア、4GB、50GB）
- **月額**: 約 ¥1,000〜¥3,000
- **メリット**: 日本語サポート、国内データセンター
- **デメリット**: マネージドサービスが少ない

#### 2. ConoHa VPS
- **特徴**: 低価格、シンプル
- **推奨プラン**: 2GBプラン（2コア、2GB、50GB）
- **月額**: 約 ¥500〜¥1,000
- **メリット**: 非常に低価格、初期費用なし
- **デメリット**: 機能が限定的

#### 3. AWS（東京リージョン）
- **特徴**: 豊富なサービス、高可用性
- **推奨構成**: EC2（t3.small）+ RDS（db.t3.micro）
- **月額**: 約 $30〜$50
- **メリット**: マネージドサービスが豊富、スケーラブル
- **デメリット**: コストが高め、設定が複雑

#### 4. Google Cloud Platform（東京リージョン）
- **特徴**: 高性能、機械学習機能
- **推奨構成**: Compute Engine（e2-small）+ Cloud SQL（db-f1-micro）
- **月額**: 約 $30〜$50
- **メリット**: 無料枠あり、高性能
- **デメリット**: コストが高め

### 海外のクラウドサービス

#### 1. Render
- **特徴**: シンプルなPaaS、無料プランあり
- **推奨構成**: Web Service + PostgreSQL
- **月額**: 無料〜$25
- **メリット**: 簡単、無料プランあり
- **デメリット**: 無料プランはスリープする

#### 2. Fly.io
- **特徴**: グローバル分散、低レイテンシ
- **推奨構成**: App + Postgres
- **月額**: 約 $10〜$30
- **メリット**: グローバル分散、シンプル
- **デメリット**: 日本語ドキュメントが少ない

#### 3. Railway
- **特徴**: シンプル、GitHub連携
- **推奨構成**: Service + Database
- **月額**: 約 $5〜$20
- **メリット**: 非常に簡単、GitHub連携
- **デメリット**: 機能が限定的

#### 4. DigitalOcean
- **特徴**: シンプルなVPS、低価格
- **推奨構成**: Droplet（2GB）+ Managed Database
- **月額**: 約 $12〜$30
- **メリット**: シンプル、低価格、ドキュメントが充実
- **デメリット**: マネージドサービスが少ない

### 推奨サービス（用途別）

#### 小規模・個人利用
- **Render**（無料プラン）または **Railway**（$5プラン）
- 理由: 低コスト、簡単、初期費用なし

#### 中規模・本番環境
- **さくらのクラウド** または **ConoHa VPS**
- 理由: 日本国内、低価格、柔軟な構成

#### 大規模・エンタープライズ
- **AWS** または **Google Cloud Platform**
- 理由: 高可用性、スケーラビリティ、マネージドサービス

---

## 次のステップ

1. **要件の確認**
   - 想定ユーザー数、データ量、予算を確認
   - 上記の情報を基に必要なリソースを決定

2. **サーバー選定**
   - 用途に応じたクラウドサービスを選択
   - 必要リソースを確保

3. **デプロイメント準備**
   - ドメインの取得・設定
   - SSL/TLS証明書の準備
   - 環境変数の設定

4. **デプロイメント実行**
   - `docker-compose.prod.yml` を使用してデプロイ
   - データベースマイグレーションの実行

5. **動作確認**
   - フロントエンドとバックエンドの動作確認
   - パフォーマンステスト

6. **監視・運用**
   - ログ監視の設定
   - バックアップの自動化
   - 定期的なメンテナンス

---

## 参考リンク

- [環境変数一覧](ENVIRONMENT_VARIABLES.md)
- [セットアップガイド](../SETUP.md)
- [非機能要件](requirements/03_非機能要件.md)
- [Docker Compose 本番設定](../docker-compose.prod.yml)

---

## お問い合わせ

サーバー選定やデプロイメントに関する質問は、GitHub Issues でお問い合わせください。



