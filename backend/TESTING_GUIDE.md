# ロール機能 動作確認手順書

このドキュメントでは、新しく実装したロール機能とメンバー更新機能の動作確認手順を説明します。

## 前提条件

- バックエンドサーバーが起動していること
- フロントエンドサーバーが起動していること
- データベースマイグレーションが実行済みであること
- テスト用の管理者アカウントが作成済みであること

## 1. ログイン

### 手順

1. ブラウザで `http://localhost:5173/admin/login` にアクセス
2. 管理者のメールアドレスとパスワードを入力
3. 「ログイン」ボタンをクリック

### 確認ポイント

- ログインに成功し、イベント一覧画面などにリダイレクトされること
- ヘッダーに「👑 オーナー」または「👤 マネージャー」と表示されること
- ナビゲーションバーに「イベント」「メンバー」「ロール」「出欠確認」「日程調整」「自分のシフト」が表示されること

## 2. ロール作成

### 手順

1. ナビゲーションバーの「ロール」リンクをクリック
2. 「新規ロール作成」ボタンをクリック
3. ロール作成モーダルが開くので、以下の情報を入力：
   - **ロール名**: 例) "リーダー"
   - **説明**: 例) "チームをまとめる責任者"
   - **色**: カラーピッカーで赤系の色を選択（例: #FF5733）
   - **表示順序**: 1
4. 「作成」ボタンをクリック

### 同様に複数のロールを作成

以下のロールを追加で作成してください：

| ロール名 | 説明 | 色 | 表示順序 |
|---------|------|-----|---------|
| サブリーダー | リーダーをサポート | #3498DB（青） | 2 |
| メンバー | 一般メンバー | #2ECC71（緑） | 3 |
| 新人 | 新しく参加したメンバー | #F39C12（オレンジ） | 4 |

### 確認ポイント

- ロール作成後、一覧にロールが表示されること
- 各ロールの色が正しく表示されること（色の四角が表示される）
- ロールが表示順序に従って並んでいること

## 3. ロール編集・削除テスト

### 編集手順

1. ロール一覧で「サブリーダー」の「編集」ボタンをクリック
2. 説明を「リーダーの補佐役」に変更
3. 色を紫（#9B59B6）に変更
4. 「更新」ボタンをクリック

### 削除手順

1. ロール一覧で「新人」の「削除」ボタンをクリック
2. 確認ダイアログで「OK」をクリック

### 確認ポイント

- 編集後、「サブリーダー」の説明と色が更新されていること
- 削除後、「新人」ロールが一覧から消えていること

## 4. メンバー一覧の確認

### 手順

1. ナビゲーションバーの「メンバー」リンクをクリック
2. メンバー一覧画面が表示される

### 確認ポイント

- 既存のメンバーが一覧で表示されること
- 各メンバーの「アクティブ状態」が表示されていること
- 「ロール」列が存在すること（まだロールは割り当てられていないので空）

## 5. メンバー新規作成（ロールなし）

### 手順

1. メンバー一覧画面で「新規メンバー追加」ボタンをクリック
2. 以下の情報を入力：
   - **表示名**: "テストユーザー1"
   - **Discord User ID**: （空欄でOK）
   - **Email**: "test1@example.com"
3. 「作成」ボタンをクリック

### 確認ポイント

- メンバーが作成され、一覧に表示されること
- ロール列は空のまま

## 6. メンバー編集とロール割り当て

### 手順

1. メンバー一覧で「テストユーザー1」の「編集」ボタンをクリック
2. メンバー編集モーダルが開く
3. 以下の操作を実施：
   - 「アクティブ」のチェックボックスがONになっていることを確認
   - 「ロール」セクションで「リーダー」にチェックを入れる
   - 「サブリーダー」にもチェックを入れる（複数選択）
4. 「更新」ボタンをクリック

### 確認ポイント

- 更新後、一覧に戻ること
- 「テストユーザー1」のロール列に「リーダー」「サブリーダー」のバッジが表示されること
- バッジの色が設定した色（赤と紫）で表示されること

## 7. 別のメンバーにロールを割り当て

### 手順

既存のメンバーを編集して、異なるロールを割り当ててください：

1. 別のメンバーの「編集」ボタンをクリック
2. 「メンバー」ロール（緑）のみにチェックを入れる
3. 「更新」ボタンをクリック

### 確認ポイント

- 更新後、そのメンバーのロール列に「メンバー」バッジ（緑）が表示されること

## 8. ロールフィルター機能のテスト

### 手順

1. メンバー一覧画面上部の「ロールでフィルター」ドロップダウンをクリック
2. 「リーダー」を選択

### 確認ポイント

- フィルター適用後、「リーダー」ロールを持つメンバーのみが表示されること
- この例では「テストユーザー1」のみが表示されるはず

### 別のロールでフィルター

1. ドロップダウンで「メンバー」を選択
2. 「メンバー」ロールを持つメンバーのみが表示されること

### フィルター解除

1. ドロップダウンで「すべて」を選択
2. 全メンバーが再び表示されること

## 9. メンバーのアクティブ/非アクティブ切り替え

### 手順

1. 「テストユーザー1」の「編集」ボタンをクリック
2. 「アクティブ」のチェックボックスを外す
3. 「更新」ボタンをクリック

### 確認ポイント

- 更新後、「テストユーザー1」の「アクティブ状態」列に「非アクティブ」と表示されること

### アクティブメンバーのみ表示

1. メンバー一覧上部の「アクティブメンバーのみ表示」にチェックを入れる
2. 「テストユーザー1」が一覧から消えること
3. チェックを外すと再び表示されること

## 10. ロール削除時の挙動確認

### 手順

1. ナビゲーションバーの「ロール」リンクをクリック
2. 「メンバー」ロール（緑）の「削除」ボタンをクリック
3. 確認ダイアログで「OK」をクリック
4. ナビゲーションバーの「メンバー」リンクをクリック

### 確認ポイント

- 削除したロールを持っていたメンバーのロール列から、そのロールバッジが消えていること
- 他のロールは影響を受けていないこと

## 11. API レスポンスの確認（オプション）

開発者ツールのネットワークタブで以下のAPIリクエストを確認できます：

### ロール一覧取得

- **URL**: `GET /api/v1/roles`
- **レスポンス例**:
```json
{
  "data": {
    "roles": [
      {
        "role_id": "01KBHMYWYKRV8PK8EVYGF1SHV0",
        "tenant_id": "01KBHMYWYKRV8PK8EVYGF1SHV0",
        "name": "リーダー",
        "description": "チームをまとめる責任者",
        "color": "#FF5733",
        "display_order": 1,
        "created_at": "2025-01-15T10:00:00Z",
        "updated_at": "2025-01-15T10:00:00Z"
      }
    ],
    "count": 3
  }
}
```

### メンバー一覧取得

- **URL**: `GET /api/v1/members`
- **レスポンス例**:
```json
{
  "data": {
    "members": [
      {
        "member_id": "01KBHN1234567890ABCDEFGHIJ",
        "tenant_id": "01KBHMYWYKRV8PK8EVYGF1SHV0",
        "display_name": "テストユーザー1",
        "email": "test1@example.com",
        "is_active": true,
        "role_ids": [
          "01KBHMYWYKRV8PK8EVYGF1SHV0",
          "01KBHMZXYZRV8PK8EVYGF1SHV1"
        ],
        "created_at": "2025-01-15T10:30:00Z",
        "updated_at": "2025-01-15T10:35:00Z"
      }
    ],
    "count": 1
  }
}
```

### メンバー更新

- **URL**: `PUT /api/v1/members/{member_id}`
- **リクエストボディ例**:
```json
{
  "display_name": "テストユーザー1",
  "email": "test1@example.com",
  "is_active": true,
  "role_ids": [
    "01KBHMYWYKRV8PK8EVYGF1SHV0",
    "01KBHMZXYZRV8PK8EVYGF1SHV1"
  ]
}
```

## 12. エラーケースのテスト

### 重複ロール名

1. ロール作成で、既に存在する「リーダー」という名前で新規作成を試みる
2. エラーメッセージが表示されること

### 必須フィールドの検証

1. メンバー編集で表示名を空にして更新を試みる
2. バリデーションエラーが表示されること

## テスト完了チェックリスト

すべての機能が正しく動作することを確認してください：

- [ ] ログインが成功する
- [ ] ロールを作成できる
- [ ] ロールを編集できる
- [ ] ロールを削除できる
- [ ] ロールに色を設定でき、UI上で反映される
- [ ] メンバーを新規作成できる
- [ ] メンバーにロールを割り当てられる
- [ ] メンバーに複数のロールを割り当てられる
- [ ] メンバー一覧でロールバッジが表示される
- [ ] ロールでフィルタリングできる
- [ ] メンバーをアクティブ/非アクティブに切り替えられる
- [ ] アクティブメンバーのみ表示できる
- [ ] ロールを削除すると、メンバーからも削除される

## トラブルシューティング

### ロールが表示されない

- ブラウザのコンソールでエラーを確認
- バックエンドのログを確認（`docker logs vrc-shift-scheduler-backend-1`）
- データベースで roles テーブルにデータが存在するか確認

### メンバー更新時にロールが保存されない

- ネットワークタブでリクエストボディに role_ids が含まれているか確認
- バックエンドのログでエラーメッセージを確認
- データベースで member_roles テーブルにデータが存在するか確認

### フィルターが動作しない

- ブラウザのコンソールでJavaScriptエラーを確認
- role_ids がメンバーオブジェクトに含まれているか確認（開発者ツールのReact DevToolsなど）

## データベース確認コマンド（参考）

```bash
# PostgreSQLコンテナに接続
docker exec -it vrc-shift-scheduler-postgres-1 psql -U vrcshift -d vrcshift

# ロール一覧を確認
SELECT role_id, name, description, color, display_order
FROM roles
WHERE deleted_at IS NULL
ORDER BY display_order;

# メンバーとロールの関連を確認
SELECT m.display_name, r.name
FROM members m
JOIN member_roles mr ON m.member_id = mr.member_id
JOIN roles r ON mr.role_id = r.role_id
WHERE r.deleted_at IS NULL
ORDER BY m.display_name, r.display_order;

# 終了
\q
```

---

以上で動作確認は完了です。すべてのチェックリストが完了していれば、ロール機能とメンバー更新機能は正常に動作しています。
