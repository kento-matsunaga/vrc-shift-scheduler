# language: ja
@shift @assignment
Feature: シフト割当（ShiftAssignment）
  イベントのシフト枠にメンバーを割り当てる機能。
  割当は手動（管理者による操作）または自動（システムによる最適化）で行われる。

  Background:
    Given テナント「VRChat Japan」が存在する
    And イベント「週末カフェ」の営業日「2026-02-21」が存在する
    And 営業日にシフト枠「受付」が存在する（必要人数: 3名、時間: 20:00〜22:00）

  # =====================================================
  # 正常系: 手動シフト割当
  # =====================================================

  Scenario: 空きのあるシフト枠にメンバーを手動で割り当てる
    Given シフト枠「受付」の現在の割当人数は 0人 である
    And メンバー「佐藤」が存在する
    When 管理者がメンバー「佐藤」をシフト枠「受付」に手動で割り当てる
    Then シフト割当が作成される
    And 割当ステータスは「confirmed」である
    And 割当方法は「manual」である
    And シフト枠「受付」の割当人数は 1人 になる

  Scenario: 必要人数ギリギリまで割り当てできる
    Given シフト枠「受付」の現在の割当人数は 2人 である
    And メンバー「田中」が存在する
    When 管理者がメンバー「田中」をシフト枠「受付」に手動で割り当てる
    Then シフト割当が作成される
    And シフト枠「受付」の割当人数は 3人 になる

  # =====================================================
  # 異常系: 満員のシフト枠への割当拒否
  # =====================================================

  Scenario: 満員のシフト枠への割当は拒否される
    Given シフト枠「受付」の現在の割当人数は 3人 である（必要人数と同じ）
    And メンバー「鈴木」が存在する
    When 管理者がメンバー「鈴木」をシフト枠「受付」に手動で割り当てる
    Then エラー「slot is full: 3/3」が返される
    And シフト割当は作成されない

  # =====================================================
  # 異常系: 存在しないリソースへの割当
  # =====================================================

  Scenario: 存在しないシフト枠への割当は失敗する
    Given メンバー「佐藤」が存在する
    When 管理者がメンバー「佐藤」を存在しないシフト枠に割り当てる
    Then エラー「shift_slot not found」が返される

  Scenario: 存在しないメンバーの割当は失敗する
    Given シフト枠「受付」の現在の割当人数は 0人 である
    When 管理者が存在しないメンバーをシフト枠「受付」に割り当てる
    Then エラー「member not found」が返される

  # =====================================================
  # シフト割当のキャンセル
  # =====================================================

  Scenario: 確定済みのシフト割当をキャンセルする
    Given メンバー「佐藤」のシフト割当が確定済みである
    When メンバー「佐藤」のシフト割当をキャンセルする
    Then 割当ステータスが「cancelled」に変更される
    And キャンセル日時が記録される
    And シフト枠の割当人数が1人減る

  Scenario: すでにキャンセル済みの割当を再キャンセルするとエラー
    Given メンバー「佐藤」のシフト割当がキャンセル済みである
    When メンバー「佐藤」のシフト割当をキャンセルする
    Then エラー「assignment is already cancelled」が返される
